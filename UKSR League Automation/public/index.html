<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UKSimRacing - League Results</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: #333;
            min-height: 100vh;
        }

        .container {
            max-width: 95%;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .auth-section, .controls-section, .results-section, .points-config-section, .penalties-section {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }





        .form-group {
            margin-bottom: 15px;
        }

        .form-row {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        .form-row .form-group {
            flex: 1;
            min-width: 200px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #555;
        }

        input, select, textarea {
            width: 100%;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #2a5298;
        }

        button {
            background: linear-gradient(135deg, #2a5298 0%, #1e3c72 100%);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            transition: transform 0.2s, box-shadow 0.2s;
            margin-right: 10px;
            margin-bottom: 10px;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(42, 82, 152, 0.3);
        }

        button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }



        .points-button {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        }

        .points-button:hover {
            box-shadow: 0 4px 15px rgba(40, 167, 69, 0.3);
        }

        .penalty-button {
            background: linear-gradient(135deg, #ffc107 0%, #e0a800 100%);
            color: #212529;
        }

        .penalty-button:hover {
            box-shadow: 0 4px 15px rgba(255, 193, 7, 0.3);
        }

        .clear-cache-button {
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
        }

        .clear-cache-button:hover {
            box-shadow: 0 4px 15px rgba(220, 53, 69, 0.3);
        }

        .status {
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            font-weight: bold;
        }

        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .status.info {
            background: #cce7ff;
            color: #004085;
            border: 1px solid #b3d7ff;
        }

        .results-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .results-table th,
        .results-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }

        .results-table th {
            background: #f8f9fa;
            font-weight: bold;
            color: #555;
            position: sticky;
            top: 0;
        }

        .results-table tbody tr:hover {
            background: #f5f5f5;
        }

        .position {
            font-weight: bold;
            color: #2a5298;
        }

        .championship-position {
            font-weight: bold;
            font-size: 1.2em;
            color: #2a5298;
        }

        .championship-position.pos-1 { color: #ffd700; }
        .championship-position.pos-2 { color: #c0c0c0; }
        .championship-position.pos-3 { color: #cd7f32; }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #2a5298;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .league-selector, .points-config {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }

        .session-item {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 15px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .session-item:hover {
            background: #e9ecef;
        }

        .session-item.upcoming {
            background: #d1ecf1;
            border-color: #bee5eb;
        }

        .session-item.upcoming:hover {
            background: #b8daff;
        }

        .session-item h4 {
            margin-bottom: 5px;
            color: #2a5298;
        }

        .session-item.upcoming h4 {
            color: #0c5460;
        }

        .session-meta {
            font-size: 0.9em;
            color: #666;
        }

        .auth-status {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }



        .league-info {
            background: #d1ecf1;
            border: 1px solid #bee5eb;
            border-radius: 5px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .points-editor {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 10px;
            margin: 15px 0;
        }

        .points-row {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .points-row label {
            min-width: 40px;
            margin-bottom: 0;
        }

        .points-row input {
            width: 80px;
            padding: 5px;
        }

        .division-filter {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 5px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .division-button {
            background: #6c757d;
            color: white;
            border: none;
            padding: 8px 15px;
            margin: 5px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 12px;
        }

        .division-button.active {
            background: #28a745;
        }

        .division-button:hover {
            opacity: 0.8;
        }

        .penalty-item {
            background: #fff3cd;
            border: 1px solid #ffeeba;
            border-radius: 5px;
            padding: 15px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 15px;
        }

        .class-item {
            background: #e7f3ff;
            border: 1px solid #b3d7ff;
            border-radius: 5px;
            padding: 15px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .class-color-preview {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            border: 2px solid #333;
            display: inline-block;
            margin-right: 10px;
        }

        .driver-reassign-item {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 10px;
            margin-bottom: 5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .penalty-form {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 15px;
            margin-bottom: 15px;
        }

        /* Detailed championship view styles */
        .results-table th small {
            display: block;
            font-weight: normal;
            color: #666;
            margin-top: 2px;
        }

        /* Championship Tabs Styles */
        .championship-tabs-container {
            background: white;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .championship-tabs {
            display: flex;
            flex-wrap: wrap;
            background: #f8f9fa;
            border-bottom: 3px solid #dee2e6;
        }

        .championship-tab {
            background: transparent;
            border: none;
            padding: 15px 25px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            color: #6c757d;
            transition: all 0.3s ease;
            border-bottom: 3px solid transparent;
            position: relative;
            display: flex;
            align-items: center;
            gap: 8px;
            min-width: 120px;
            justify-content: center;
        }

        .championship-tab:hover {
            background: #e9ecef;
            color: #495057;
            transform: none;
            box-shadow: none;
        }

        .championship-tab.active {
            background: white;
            color: #2a5298;
            border-bottom-color: #2a5298;
            box-shadow: 0 -2px 10px rgba(42, 82, 152, 0.1);
        }

        .championship-tab .tab-count {
            background: #6c757d;
            color: white;
            border-radius: 12px;
            padding: 2px 8px;
            font-size: 11px;
            font-weight: bold;
            min-width: 20px;
            text-align: center;
        }

        .championship-tab.active .tab-count {
            background: #2a5298;
        }

        /* Responsive tabs */
        @media (max-width: 768px) {
            .championship-tabs {
                flex-direction: column;
            }
            
            .championship-tab {
                justify-content: flex-start;
                min-width: auto;
                width: 100%;
            }
        }

        /* Enhanced tab animations */
        .championship-tab::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(135deg, #2a5298 0%, #1e3c72 100%);
            transform: scaleX(0);
            transition: transform 0.3s ease;
        }

        .championship-tab.active::before {
            transform: scaleX(1);
        }

        .results-table td[title*="P1"] {
            background-color: #ffd700 !important;
            font-weight: bold;
        }

        .results-table td[title*="P2"] {
            background-color: #e6e6fa;
            font-weight: bold;
        }

        .results-table td[title*="P3"] {
            background-color: #deb887;
            font-weight: bold;
        }

        @media (max-width: 768px) {
            .form-row {
                flex-direction: column;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .container {
                padding: 10px;
            }
            
            .results-table {
                font-size: 12px;
            }
            
            .results-table th,
            .results-table td {
                padding: 8px 4px;
            }

            .points-editor {
                grid-template-columns: repeat(2, 1fr);
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🏁 UKSimRacing League Results</h1>
        </div>



        <!-- Authentication Section -->
        <div class="auth-section">
            <h2>🔐 iRacing Authentication</h2>
            <div id="authStatus"></div>
            <div id="authForm">
                <div class="form-row">
                    <div class="form-group">
                        <label for="username">iRacing Username/Email:</label>
                        <input type="email" id="username" placeholder="your.email@example.com" value="">
                    </div>
                    <div class="form-group">
                        <label for="password">iRacing Password:</label>
                        <input type="password" id="password" placeholder="Your iRacing password" value="">
                    </div>
                </div>
                <button onclick="authenticate()">Connect to iRacing</button>
            </div>
        </div>

        <!-- League Selection & Controls -->
        <div class="controls-section" id="controlsSection" style="display: none;">
            <h2>⚙️ League & Display Options</h2>
            
            <!-- League Search/ID Input -->
            <div class="league-selector">
                <div class="form-row">
                    <div class="form-group">
                        <label for="leagueSearch">League Search or Direct ID:</label>
                        <input type="text" id="leagueSearch" placeholder="Enter league name or league ID (e.g., 'UKSR' or '7965')">
                        <small style="color: #666; font-size: 0.9em;">
                            💡 Enter a league name to search, or enter a number for direct league ID lookup
                        </small>
                    </div>
                </div>
                <button onclick="handleLeagueSearch()">Search / Load League</button>
            </div>

            <!-- League Info Display -->
            <div id="leagueInfo" style="display: none;" class="league-info">
                <h4 id="leagueInfoTitle">League Information</h4>
                <div id="leagueInfoContent"></div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label for="seasonSelect">Season:</label>
                    <select id="seasonSelect" onchange="handleSeasonChange()">
                        <option value="">-- Select Season --</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="displayType">Display Type:</label>
                    <select id="displayType" onchange="handleDisplayTypeChange()">
                        <option value="upcoming">Upcoming Sessions</option>
                        <option value="results">Race Results</option>
                        <option value="championship">Championship Standings</option>
                    </select>
                </div>
            </div>

            <div class="form-row" id="dataControls" style="display: none;">
                <div class="form-group">
                    <span id="lastUpdated" style="color: #666; font-size: 0.9em; margin-left: 10px;"></span>
                </div>
            </div>

            <button onclick="refreshData()" class="points-button">🔄 Refresh Data Now!</button>
            <button onclick="clearCache()" class="clear-cache-button">🗑️ Clear Cache</button>
            <button onclick="togglePointsConfig()" class="points-button">⚙️ Configure Points</button>
            <button onclick="toggleClassManagement()" style="background: linear-gradient(135deg, #17a2b8 0%, #138496 100%); color: white; border: none; padding: 12px 25px; border-radius: 5px; cursor: pointer; font-size: 14px; font-weight: bold; margin-right: 10px; margin-bottom: 10px;">🏎️ Manage Classes</button>
            <button onclick="toggleRosterManagement()" style="background: linear-gradient(135deg, #6f42c1 0%, #e83e8c 100%); color: white; border: none; padding: 12px 25px; border-radius: 5px; cursor: pointer; font-size: 14px; font-weight: bold; margin-right: 10px; margin-bottom: 10px;">👥 Manage Roster</button>
            <button onclick="togglePenaltiesManagement()" class="penalty-button">⚠️ Manage Penalties</button>
            <button onclick="toggleWidgetPublisher()" style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%); color: white; border: none; padding: 12px 25px; border-radius: 5px; cursor: pointer; font-size: 14px; font-weight: bold; margin-right: 10px; margin-bottom: 10px;">🔗 Publish Widget</button>
        </div>

        <!-- Roster Management Section -->
        <div class="points-config-section" id="rosterManagementSection" style="display: none;">
            <h2>👥 Roster Management <button onclick="toggleRosterManagement()" style="float: right; background: linear-gradient(135deg, #6c757d 0%, #495057 100%); color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; font-size: 14px;">✕ Close</button></h2>
            <div id="rosterManagementContainer">
                <p>Please select a league and season first.</p>
            </div>
        </div>

        <!-- Class Management Section -->
        <div class="points-config-section" id="classManagementSection" style="display: none;">
            <h2>🏎️ Class Management <button onclick="toggleClassManagement()" style="float: right; background: linear-gradient(135deg, #6c757d 0%, #495057 100%); color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; font-size: 14px;">✕ Close</button></h2>
            <div id="classManagementContainer">
                <p>Please select a league and season first.</p>
            </div>
        </div>

        <!-- Penalties Management Section -->
        <div class="points-config-section" id="penaltiesSection" style="display: none;">
            <h2>⚠️ Penalty Management <button onclick="togglePenaltiesManagement()" style="float: right; background: linear-gradient(135deg, #6c757d 0%, #495057 100%); color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; font-size: 14px;">✕ Close</button></h2>
            <div id="penaltiesContainer">
                <p>Please select a league and season first.</p>
            </div>
        </div>

        <!-- Points Configuration Section -->
        <div class="points-config-section" id="pointsConfigSection" style="display: none;">
            <h2>🏆 Championship Points Configuration <button onclick="togglePointsConfig()" style="float: right; background: linear-gradient(135deg, #6c757d 0%, #495057 100%); color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; font-size: 14px;">✕ Close</button></h2>
            
            <div class="points-config">
                <div class="form-row">
                    <div class="form-group">
                        <label for="pointsConfigName">Configuration Name:</label>
                        <input type="text" id="pointsConfigName" placeholder="Enter configuration name">
                    </div>
                    <div class="form-group">
                        <label for="pointsPreset">Load Preset:</label>
                        <select id="pointsPreset" onchange="loadPointsPreset()">
                            <option value="">-- Select Preset --</option>
                        </select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="dropWeeks">Drop Weeks:</label>
                        <input type="number" id="dropWeeks" min="0" max="10" value="2" placeholder="2">
                        <small style="color: #666; font-size: 0.9em;">
                            Number of lowest scores to drop from championship calculation
                        </small>
                    </div>
                    <div class="form-group">
                        <label for="fastestLapPoints">Fastest Lap Bonus:</label>
                        <input type="number" id="fastestLapPoints" min="0" max="10" value="1" placeholder="1">
                        <small style="color: #666; font-size: 0.9em;">
                            Bonus points awarded for fastest lap in each division (0 to disable)
                        </small>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="polePositionPoints">Pole Position Bonus:</label>
                        <input type="number" id="polePositionPoints" min="0" max="10" value="1" placeholder="1">
                        <small style="color: #666; font-size: 0.9em;">
                            Bonus points awarded for pole position in each division (0 to disable)
                        </small>
                    </div>
                </div>
                
                <h4>Points by Position:</h4>
                <small style="color: #666;">Set points for each finishing position. Leave empty for positions that don't score points.</small>
                <div class="points-editor" id="pointsEditor">
                    <!-- Points inputs will be dynamically generated -->
                </div>
                
                <div style="margin-top: 15px;">
                    <button onclick="addMorePositions()" class="points-button">+ Add More Positions</button>
                    <button onclick="savePointsConfig()" class="points-button">💾 Save Configuration</button>
                    <button onclick="togglePointsConfig()">Cancel</button>
                </div>
                
                <div id="pointsConfigStatus"></div>
            </div>
        </div>

        <!-- Widget Publisher Section -->
        <div class="points-config-section" id="widgetPublisherSection" style="display: none;">
            <h2>🔗 Championship Widget Publisher <button onclick="toggleWidgetPublisher()" style="float: right; background: linear-gradient(135deg, #6c757d 0%, #495057 100%); color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; font-size: 14px;">✕ Close</button></h2>
            
            <div id="widgetPublisherContainer">
                <p>Please select a league and season first to generate widget code.</p>
            </div>
        </div>

        <!-- Results Display -->
        <div class="results-section">
            <h2 id="resultsTitle">📊 Results</h2>
            <div id="resultsContainer">
                <p>Please authenticate to view results.</p>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let currentLeagueId = null;
        let currentSeasonId = null;
        let currentLeagueData = null;
        let currentSeasonSessions = null;
        let currentPointsConfig = null;
        let currentDivisionFilter = 'all';
        let currentRoster = null;
        let autoRefreshInterval = null;

        // Check authentication status on page load
        document.addEventListener('DOMContentLoaded', checkAuthStatus);

        async function checkAuthStatus() {
            try {
                const response = await fetch('/api/auth/status', {
                    credentials: 'include'
                });
                const data = await response.json();
                
                if (data.authenticated) {
                    showAuthenticatedState(data.username);
                }
            } catch (error) {
                console.error('Auth status check failed:', error);
            }
        }



        async function authenticate() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const statusDiv = document.getElementById('authStatus');

            if (!username || !password) {
                showStatus(statusDiv, 'Please enter both username and password', 'error');
                return;
            }

            showStatus(statusDiv, 'Authenticating...', 'info');

            try {
                const response = await fetch('/api/auth', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ username, password }),
                    credentials: 'include'
                });

                const data = await response.json();

                if (response.ok) {
                    showAuthenticatedState(data.username);
                    showStatus(statusDiv, 'Authentication successful!', 'success');
                } else {
                    throw new Error(data.error || 'Authentication failed');
                }
            } catch (error) {
                console.error('Auth error:', error);
                showStatus(statusDiv, `Authentication failed: ${error.message}`, 'error');
            }
        }

        function showAuthenticatedState(username) {
            const authForm = document.getElementById('authForm');
            const authStatus = document.getElementById('authStatus');
            const controlsSection = document.getElementById('controlsSection');
            
            authForm.style.display = 'none';
            controlsSection.style.display = 'block';
            
            authStatus.innerHTML = `
                <div class="auth-status">
                    <span>✅ Connected as: <strong>${username}</strong></span>
                    <button onclick="logout()" style="background: #dc3545; padding: 5px 10px; font-size: 12px;">Logout</button>
                </div>
            `;
        }

        async function logout() {
            try {
                await fetch('/api/auth/logout', {
                    method: 'POST',
                    credentials: 'include'
                });
                location.reload();
            } catch (error) {
                console.error('Logout error:', error);
            }
        }

        async function handleLeagueSearch() {
            const searchTerm = document.getElementById('leagueSearch').value.trim();
            
            if (!searchTerm) {
                alert('Please enter a league name or ID');
                return;
            }

            // Check if it's a number (direct league ID)
            if (/^\d+$/.test(searchTerm)) {
                // Direct league ID lookup
                await loadLeagueData(searchTerm);
            } else {
                // Search by name
                try {
                    showLoading('Searching leagues...');
                    
                    const response = await fetch(`/api/league/search?search=${encodeURIComponent(searchTerm)}`, {
                        credentials: 'include'
                    });
                    
                    if (!response.ok) {
                        throw new Error('Failed to search leagues');
                    }
                    
                    const data = await response.json();
                    
                    if (data && data.leagues && data.leagues.length > 0) {
                        // If only one result, auto-load it
                        if (data.leagues.length === 1) {
                            await loadLeagueData(data.leagues[0].league_id);
                        } else {
                            // Multiple results - show selection
                            let leagueOptions = data.leagues.map(league => 
                                `${league.league_name} (ID: ${league.league_id})`
                            ).join('\n');
                            
                            const selectedLeague = prompt(`Multiple leagues found:\n\n${leagueOptions}\n\nEnter the League ID you want to load:`);
                            if (selectedLeague && /^\d+$/.test(selectedLeague.trim())) {
                                await loadLeagueData(selectedLeague.trim());
                            }
                        }
                    } else {
                        alert('No leagues found with that name');
                    }

                    hideLoading();
                    
                } catch (error) {
                    console.error('League search error:', error);
                    hideLoading();
                    alert('Error searching leagues: ' + error.message);
                }
            }
        }

        async function loadLeagueData(leagueId) {
            if (!leagueId) {
                alert('Please select a league or enter a league ID');
                return;
            }

            currentLeagueId = leagueId;
            
            try {
                showLoading('Loading league data and caching to database...');
                
                // Load league info
                const leagueResponse = await fetch(`/api/league/${leagueId}`, {
                    credentials: 'include'
                });
                
                if (!leagueResponse.ok) {
                    throw new Error('Failed to load league data');
                }
                
                currentLeagueData = await leagueResponse.json();
                
                // Display league info
                displayLeagueInfo(currentLeagueData);
                
                // Load seasons
                const seasonsResponse = await fetch(`/api/league/${leagueId}/seasons`, {
                    credentials: 'include'
                });
                
                if (!seasonsResponse.ok) {
                    throw new Error('Failed to load seasons');
                }
                
                const seasonsData = await seasonsResponse.json();
                
                const seasonSelect = document.getElementById('seasonSelect');
                seasonSelect.innerHTML = '<option value="">-- Select Season --</option>';
                
                let activeSeason = null;
                if (seasonsData && seasonsData.seasons) {
                    seasonsData.seasons.forEach(season => {
                        const option = document.createElement('option');
                        option.value = season.season_id;
                        option.textContent = season.season_name + (season.active ? ' (Active)' : '');
                        seasonSelect.appendChild(option);
                        
                        // Track active season
                        if (season.active) {
                            activeSeason = season;
                        }
                    });
                }

                // Load points configuration
                await loadPointsConfigForLeague(leagueId);

                // Auto-select active season and load data
                if (activeSeason) {
                    seasonSelect.value = activeSeason.season_id;
                    currentSeasonId = activeSeason.season_id;
                    
                    // Show data controls
                    document.getElementById('dataControls').style.display = 'block';
                    
                    // Load default view (upcoming sessions) from database first
                    document.getElementById('displayType').value = 'upcoming';
                    await loadFromDatabase('upcoming');
                    
                    // Cache data in background (no loading message)
                    cacheSeasonDataInBackground(leagueId, activeSeason.season_id);
                    
                    // Start auto-refresh
                    startAutoRefresh();
                }

                hideLoading();
                
            } catch (error) {
                console.error('League data error:', error);
                hideLoading();
                alert('Error loading league data: ' + error.message);
            }
        }

        function displayLeagueInfo(leagueData) {
            const leagueInfo = document.getElementById('leagueInfo');
            const leagueInfoContent = document.getElementById('leagueInfoContent');
            
            if (leagueData && leagueData.league_name) {
                leagueInfoContent.innerHTML = `
                    <p><strong>League:</strong> ${leagueData.league_name}</p>
                    <p><strong>Owner:</strong> ${leagueData.owner?.display_name || 'Unknown'}</p>
                    <p><strong>League ID:</strong> ${leagueData.league_id}</p>
                    <p><strong>Members:</strong> ${leagueData.roster_count || 0}</p>
                    ${leagueData.about ? `<p><strong>About:</strong> ${leagueData.about}</p>` : ''}
                `;
                leagueInfo.style.display = 'block';
            }
        }

        async function handleSeasonChange() {
            const seasonId = document.getElementById('seasonSelect').value;
            if (!seasonId || !currentLeagueId) return;
            
            currentSeasonId = seasonId;
            
            // Show data controls
            document.getElementById('dataControls').style.display = 'block';
            
            // Load current display type from database first
            const displayType = document.getElementById('displayType').value;
            await loadFromDatabase(displayType);
            
            // Cache data in background
            cacheSeasonDataInBackground(currentLeagueId, seasonId);
            
            // Start auto-refresh
            startAutoRefresh();
        }

        async function handleDisplayTypeChange() {
            const displayType = document.getElementById('displayType').value;
            if (!currentLeagueId || !currentSeasonId) return;
            
            await loadFromDatabase(displayType);
        }

        async function cacheSeasonData(leagueId, seasonId) {
            try {
                showLoading('Caching season data to database...');
                
                const response = await fetch(`/api/league/${leagueId}/season/${seasonId}/cache`, {
                    method: 'POST',
                    credentials: 'include'
                });
                
                if (!response.ok) {
                    throw new Error('Failed to cache season data');
                }
                
                const data = await response.json();
                updateLastUpdatedTime(data.cached_at);
                
            } catch (error) {
                console.error('Error caching season data:', error);
                // Don't show error to user, just log it
            }
        }

        async function cacheSeasonDataInBackground(leagueId, seasonId) {
            try {
                console.log('🔄 Refreshing data in background...');
                
                const response = await fetch(`/api/league/${leagueId}/season/${seasonId}/cache`, {
                    method: 'POST',
                    credentials: 'include'
                });
                
                if (!response.ok) {
                    throw new Error('Failed to cache season data');
                }
                
                const data = await response.json();
                updateLastUpdatedTime(data.cached_at);
                console.log('✅ Background data refresh completed');
                
            } catch (error) {
                console.error('Error caching season data in background:', error);
                // Don't show error to user, just log it
            }
        }

        async function loadFromDatabase(displayType) {
            if (!currentLeagueId || !currentSeasonId) return;
            
            try {
                showLoading('Loading data...');
                
                let endpoint;
                switch (displayType) {
                    case 'upcoming':
                        endpoint = `/api/league/${currentLeagueId}/season/${currentSeasonId}/sessions?cached=true&upcoming=true`;
                        break;
                    case 'results':
                        endpoint = `/api/league/${currentLeagueId}/season/${currentSeasonId}/sessions?cached=true&results_only=true`;
                        break;
                    case 'championship':
                        endpoint = `/api/league/${currentLeagueId}/season/${currentSeasonId}/championship?cached=true`;
                        break;
                    default:
                        return;
                }
                
                const response = await fetch(endpoint, {
                    credentials: 'include'
                });
                
                if (!response.ok) {
                    throw new Error(`Failed to load ${displayType} data`);
                }
                
                const data = await response.json();
                
                // Display the data based on type
                switch (displayType) {
                    case 'upcoming':
                        currentSeasonSessions = data.sessions;
                        displayUpcomingSessions(data.sessions);
                        break;
                    case 'results':
                        currentSeasonSessions = data.sessions;
                        displayPastSessions(data.sessions);
                        break;
                    case 'championship':
                        displayChampionshipStandings(data);
                        break;
                }
                
                if (data.last_updated) {
                    updateLastUpdatedTime(data.last_updated);
                }
                
                hideLoading();
                
            } catch (error) {
                console.error('Error loading from database:', error);
                hideLoading();
                alert(`Error loading ${displayType} data: ${error.message}`);
            }
        }

        async function toggleRosterManagement() {
            const section = document.getElementById('rosterManagementSection');
            const isVisible = section.style.display !== 'none';
            
            if (isVisible) {
                section.style.display = 'none';
            } else {
                if (!currentLeagueId || !currentSeasonId) {
                    alert('Please select a league and season first');
                    return;
                }
                
                section.style.display = 'block';
                await loadRosterManagementData();
            }
        }

        async function loadRosterManagementData() {
            try {
                const container = document.getElementById('rosterManagementContainer');
                container.innerHTML = '<div style="text-align: center; padding: 20px;"><div class="spinner" style="border: 4px solid #f3f3f3; border-top: 4px solid #2a5298; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 0 auto 20px;"></div><p>Loading roster management...</p></div>';
                
                // Load roster data
                const response = await fetch(`/api/league/${currentLeagueId}/roster?cached=true`, {
                    credentials: 'include'
                });
                
                if (!response.ok) {
                    throw new Error('Failed to load roster data');
                }
                
                const data = await response.json();
                currentRoster = data.roster;
                
                displayRosterInManagement(data);
                
            } catch (error) {
                console.error('Error loading roster management:', error);
                const container = document.getElementById('rosterManagementContainer');
                container.innerHTML = '<p style="color: red;">Error loading roster management: ' + error.message + '</p>';
            }
        }

        async function toggleClassManagement() {
            const section = document.getElementById('classManagementSection');
            const isVisible = section.style.display !== 'none';
            
            if (isVisible) {
                section.style.display = 'none';
            } else {
                if (!currentLeagueId || !currentSeasonId) {
                    alert('Please select a league and season first');
                    return;
                }
                
                section.style.display = 'block';
                await loadClassManagementData();
            }
        }

        async function togglePenaltiesManagement() {
            const section = document.getElementById('penaltiesSection');
            const isVisible = section.style.display !== 'none';
            
            if (isVisible) {
                section.style.display = 'none';
            } else {
                if (!currentLeagueId || !currentSeasonId) {
                    alert('Please select a league and season first');
                    return;
                }
                
                section.style.display = 'block';
                await loadPenaltiesManagementData();
            }
        }

        async function loadPenaltiesManagementData() {
            try {
                // Don't show loading in the main results container, just update the penalties section
                const container = document.getElementById('penaltiesContainer');
                container.innerHTML = '<div style="text-align: center; padding: 20px;"><div class="spinner" style="border: 4px solid #f3f3f3; border-top: 4px solid #2a5298; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 0 auto 20px;"></div><p>Loading penalties management...</p></div>';
                
                // Load roster if not already loaded
                if (!currentRoster) {
                    const rosterResponse = await fetch(`/api/league/${currentLeagueId}/roster?cached=true`, {
                        credentials: 'include'
                    });
                    if (rosterResponse.ok) {
                        const rosterData = await rosterResponse.json();
                        currentRoster = rosterData.roster;
                    }
                }
                
                // Load sessions if not already loaded
                if (!currentSeasonSessions) {
                    const sessionsResponse = await fetch(`/api/league/${currentLeagueId}/season/${currentSeasonId}/sessions?cached=true&results_only=true`, {
                        credentials: 'include'
                    });
                    if (sessionsResponse.ok) {
                        const sessionsData = await sessionsResponse.json();
                        currentSeasonSessions = sessionsData.sessions;
                    }
                }
                
                // Load existing penalties
                const penaltiesResponse = await fetch(`/api/league/${currentLeagueId}/season/${currentSeasonId}/penalties?cached=true`, {
                    credentials: 'include'
                });
                
                let penalties = {};
                if (penaltiesResponse.ok) {
                    const data = await penaltiesResponse.json();
                    penalties = data.penalties;
                }
                
                displayPenaltiesInSection(penalties);
                
            } catch (error) {
                console.error('Error loading penalties management:', error);
                const container = document.getElementById('penaltiesContainer');
                container.innerHTML = '<p style="color: red;">Error loading penalties management: ' + error.message + '</p>';
            }
        }

        function displayPenaltiesInSection(penalties) {
            const container = document.getElementById('penaltiesContainer');
            
            if (!currentSeasonSessions || !currentRoster) {
                container.innerHTML = '<p>Please load roster and sessions data first.</p>';
                return;
            }

            let penaltiesHTML = `
                <div style="background: #fff3cd; border: 1px solid #ffeaa7; padding: 10px; border-radius: 5px; margin-bottom: 15px;">
                    <strong>⚠️ Penalty Management</strong><br>
                    Add penalty points to drivers for specific races. Penalties are subtracted from race points and integrate with drop weeks.
                </div>
                
                <div class="penalty-form">
                    <h4>Add New Penalty</h4>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="penaltySession">Session:</label>
                            <select id="penaltySession">
                                <option value="">-- Select Session --</option>
                                ${currentSeasonSessions.map(session => {
                                    const sessionDate = session.launch_at ? new Date(session.launch_at).toLocaleDateString() : 
                                                       session.start_time ? new Date(session.start_time).toLocaleDateString() : '';
                                    const trackName = session.track?.track_name || session.track_name || 'Unknown Track';
                                    const sessionName = session.session_name || session.private_session_name || 'Race Session';
                                    return `
                                        <option value="${session.subsession_id}">
                                            ${sessionDate} - ${sessionName} - ${trackName}
                                        </option>
                                    `;
                                }).join('')}
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="penaltyDriver">Driver:</label>
                            <select id="penaltyDriver">
                                <option value="">-- Select Driver --</option>
                                ${currentRoster.map(member => `
                                    <option value="${member.cust_id}">
                                        ${member.display_name} (${member.cust_id})
                                    </option>
                                `).join('')}
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="penaltyPoints">Penalty Points:</label>
                            <input type="number" id="penaltyPoints" placeholder="Enter penalty points (positive number)" min="0">
                        </div>
                        <div class="form-group">
                            <label for="penaltyReason">Reason (optional):</label>
                            <input type="text" id="penaltyReason" placeholder="Reason for penalty">
                        </div>
                    </div>
                    <button onclick="addPenalty()" class="penalty-button">Add Penalty</button>
                    <button onclick="toggleCSVUpload()" class="penalty-button" style="margin-left: 10px; background: linear-gradient(135deg, #17a2b8 0%, #138496 100%);">📄 Add Penalty via .CSV</button>
                    <div id="penaltyStatus"></div>
                </div>
                
                <!-- CSV Upload Section -->
                <div class="penalty-form" id="csvUploadSection" style="display: none;">
                    <h4>📄 Upload Penalties via CSV</h4>
                    <div style="background: #e7f3ff; border: 1px solid #b3d7ff; padding: 10px; border-radius: 5px; margin-bottom: 15px;">
                        <strong>CSV Format Expected:</strong><br>
                        <code>Date issued,League,Race,Summary,Driver name,Infringement,Penalty,License points</code><br>
                        <small>• Race → Session (fuzzy matching)<br>
                        • Summary → Reason<br>
                        • Driver Name → Driver (fuzzy matching)<br>
                        • Infringement → Prepended to reason<br>
                        • Penalty → Penalty Points (warnings ignored)</small>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="csvFile">Select CSV File:</label>
                            <input type="file" id="csvFile" accept=".csv" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 3px;">
                        </div>
                    </div>
                    <button onclick="uploadCSV()" class="penalty-button">Upload and Process CSV</button>
                    <button onclick="toggleCSVUpload()" style="background: #6c757d; color: white; padding: 8px 15px; border: none; border-radius: 3px; cursor: pointer; margin-left: 10px;">Cancel</button>
                    <div id="csvUploadStatus"></div>
                </div>
                
                <h4>Existing Penalties</h4>
                <div id="penaltiesList">
            `;

            // Display existing penalties
            const penaltyEntries = Object.entries(penalties);
            if (penaltyEntries.length === 0) {
                penaltiesHTML += '<p>No penalties assigned yet.</p>';
            } else {
                // Sort sessions by date (most recent first)
                const sortedPenaltyEntries = penaltyEntries.sort(([subsessionIdA], [subsessionIdB]) => {
                    const sessionA = currentSeasonSessions.find(s => s.subsession_id == subsessionIdA);
                    const sessionB = currentSeasonSessions.find(s => s.subsession_id == subsessionIdB);
                    
                    const dateA = sessionA?.launch_at ? new Date(sessionA.launch_at) : new Date(0);
                    const dateB = sessionB?.launch_at ? new Date(sessionB.launch_at) : new Date(0);
                    
                    return dateB - dateA; // Most recent first
                });
                
                let totalPenalties = 0;
                sortedPenaltyEntries.forEach(([subsessionId, sessionPenalties]) => {
                    const session = currentSeasonSessions.find(s => s.subsession_id == subsessionId);
                    const sessionName = session ? session.session_name || session.private_session_name || 'Race Session' : 'Unknown Session';
                    const sessionDate = session?.launch_at ? new Date(session.launch_at).toLocaleDateString() : 'Unknown Date';
                    const trackName = session?.track?.track_name || session?.track_name || 'Unknown Track';
                    
                    const sessionPenaltyCount = Object.keys(sessionPenalties).length;
                    totalPenalties += sessionPenaltyCount;
                    
                    penaltiesHTML += `
                        <h5>📋 ${sessionName} - ${trackName} (${sessionDate}) - ${sessionPenaltyCount} ${sessionPenaltyCount === 1 ? 'penalty' : 'penalties'}</h5>
                    `;
                    
                    // Sort penalties within session by driver name
                    const sortedSessionPenalties = Object.entries(sessionPenalties).sort(([custIdA, penaltyA], [custIdB, penaltyB]) => {
                        const driverA = currentRoster.find(r => r.cust_id == custIdA);
                        const driverB = currentRoster.find(r => r.cust_id == custIdB);
                        const nameA = driverA ? driverA.display_name : 'Unknown Driver';
                        const nameB = driverB ? driverB.display_name : 'Unknown Driver';
                        return nameA.localeCompare(nameB);
                    });
                    
                    sortedSessionPenalties.forEach(([custId, penalty]) => {
                        const driver = currentRoster.find(r => r.cust_id == custId);
                        const driverName = driver ? driver.display_name : 'Unknown Driver';
                        const penaltyDate = penalty.timestamp ? new Date(penalty.timestamp).toLocaleString() : 'Unknown time';
                        
                        penaltiesHTML += `
                            <div class="penalty-item">
                                <div style="flex: 1;">
                                    <strong>${driverName}</strong> (ID: ${custId})<br>
                                    <span style="color: #dc3545; font-weight: bold; font-size: 1.1em;">-${penalty.points} penalty points</span>
                                    ${penalty.reason ? `<br><em>Reason: ${penalty.reason}</em>` : '<br><em>No reason specified</em>'}
                                    <br><small style="color: #666;">Applied: ${penaltyDate}</small>
                                </div>
                                <button onclick="removePenalty('${subsessionId}', '${custId}')" 
                                        style="background: #dc3545; color: white; padding: 8px 12px; border: none; border-radius: 3px; cursor: pointer; align-self: flex-start;">
                                    Remove
                                </button>
                            </div>
                        `;
                    });
                });
                
                // Add summary at the top
                penaltiesHTML = penaltiesHTML.replace('<h4>Existing Penalties</h4>', 
                    `<h4>Existing Penalties (${totalPenalties} total across ${penaltyEntries.length} ${penaltyEntries.length === 1 ? 'session' : 'sessions'})</h4>`);
            }

            penaltiesHTML += '</div>';
            container.innerHTML = penaltiesHTML;
        }

        async function loadClassManagementData() {
            try {
                const container = document.getElementById('classManagementContainer');
                container.innerHTML = '<div style="text-align: center; padding: 20px;"><div class="spinner" style="border: 4px solid #f3f3f3; border-top: 4px solid #2a5298; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 0 auto 20px;"></div><p>Loading class management...</p></div>';
                
                // Load roster if not already loaded
                if (!currentRoster) {
                    const rosterResponse = await fetch(`/api/league/${currentLeagueId}/roster?cached=true`, {
                        credentials: 'include'
                    });
                    if (rosterResponse.ok) {
                        const rosterData = await rosterResponse.json();
                        currentRoster = rosterData.roster;
                    }
                }
                
                await displayClassManagement();
                
            } catch (error) {
                console.error('Error loading class management:', error);
                const container = document.getElementById('classManagementContainer');
                container.innerHTML = '<p style="color: red;">Error loading class management: ' + error.message + '</p>';
            }
        }

        async function displayClassManagement() {
            const container = document.getElementById('classManagementContainer');
            
            if (!currentRoster) {
                container.innerHTML = '<p>Please load roster data first.</p>';
                return;
            }

            // Load classes from database and extract from roster
            let savedClasses = {};
            try {
                const response = await fetch(`/api/league/${currentLeagueId}/classes`, {
                    credentials: 'include'
                });
                if (response.ok) {
                    const data = await response.json();
                    data.classes.forEach(cls => {
                        savedClasses[cls.name] = { name: cls.name, color: cls.color, drivers: [] };
                    });
                }
            } catch (error) {
                console.error('Error loading saved classes:', error);
            }

            // Ensure EXCLUDED class exists
            if (!savedClasses['EXCLUDED']) {
                savedClasses['EXCLUDED'] = {
                    name: 'EXCLUDED',
                    color: '#000000',
                    drivers: []
                };
                // Auto-create the EXCLUDED class in the database
                try {
                    await fetch(`/api/league/${currentLeagueId}/classes`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ name: 'EXCLUDED', color: '#000000' }),
                        credentials: 'include'
                    });
                } catch (error) {
                    console.error('Error auto-creating EXCLUDED class:', error);
                }
            }

            // Extract classes from roster and merge with saved classes
            const classes = { ...savedClasses };
            const driversWithoutClass = [];
            
            currentRoster.forEach(member => {
                const nickName = member.nick_name || '';
                const divisionMatch = nickName.match(/\[([^\]]+)\]/);
                
                if (divisionMatch) {
                    const className = divisionMatch[1];
                    if (!classes[className]) {
                        classes[className] = {
                            name: className,
                            color: getClassColor(className),
                            drivers: []
                        };
                    }
                    classes[className].drivers.push(member);
                } else {
                    driversWithoutClass.push(member);
                }
            });

            let classHTML = `
                <div style="background: #e7f3ff; border: 1px solid #b3d7ff; padding: 10px; border-radius: 5px; margin-bottom: 15px;">
                    <strong>🏎️ Class Management</strong><br>
                    Manage class names, colors, and driver assignments. Changes will recalculate championship standings.
                </div>
                
                <div style="background: #f8d7da; border: 1px solid #f5c6cb; padding: 10px; border-radius: 5px; margin-bottom: 15px;">
                    <strong>🚫 EXCLUDED Class:</strong> Drivers assigned to "EXCLUDED", "EXCLUDE", "NON-COMPETING", or "NON_COMPETING" classes are completely excluded from all championship calculations but can still participate in races. This is useful for admins, broadcasters, or test drivers.
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <h4>Add New Class</h4>
                        <div style="display: flex; gap: 10px; align-items: end;">
                            <div style="flex: 1;">
                                <label for="newClassName">Class Name:</label>
                                <input type="text" id="newClassName" placeholder="Enter class name (e.g., GT3, LMP2, EXCLUDED)">
                            </div>
                            <div style="flex: 1;">
                                <label for="newClassColor">Class Color:</label>
                                <input type="color" id="newClassColor" value="#28a745">
                            </div>
                            <button onclick="addNewClass()" style="background: linear-gradient(135deg, #17a2b8 0%, #138496 100%); color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer;">Add Class</button>
                        </div>
                    </div>
                </div>
                
                <div id="classManagementContent">
                    <!-- Class list will be populated here -->
                </div>
            `;
            
            container.innerHTML = classHTML;
            
            // Now display the existing classes
            displayClassesInUI(classes, driversWithoutClass);
        }

        function displayClassesInUI(classes, driversWithoutClass) {
            const contentDiv = document.getElementById('classManagementContent');
            
            if (!contentDiv) {
                console.error('Class management content div not found');
                return;
            }
            
            let classesHTML = '<h4>Existing Classes</h4>';
            
            const classEntries = Object.entries(classes);
            if (classEntries.length === 0) {
                classesHTML += '<p style="color: #666;">No classes defined yet. Add your first class above.</p>';
            } else {
                classesHTML += '<div style="display: grid; gap: 10px;">';
                
                classEntries.forEach(([className, classData]) => {
                    const driverCount = classData.drivers ? classData.drivers.length : 0;
                    const isExcluded = className.toUpperCase() === 'EXCLUDED' || 
                                     className.toUpperCase() === 'EXCLUDE' ||
                                     className.toUpperCase() === 'NON-COMPETING' ||
                                     className.toUpperCase() === 'NON_COMPETING';
                    
                    const indicator = isExcluded ? '🚫 ' : '';
                    
                    classesHTML += `
                        <div class="class-item">
                            <div style="display: flex; align-items: center; flex: 1;">
                                <div class="class-color-preview" style="background-color: ${classData.color};"></div>
                                <div>
                                    <strong>${indicator}${className}</strong>
                                    <div style="font-size: 0.9em; color: #666;">
                                        ${driverCount} driver${driverCount !== 1 ? 's' : ''} assigned
                                        ${isExcluded ? '<br><small style="color: #dc3545;">Excluded from championships</small>' : ''}
                                    </div>
                                </div>
                            </div>
                            <div style="display: flex; gap: 5px;">
                                <button onclick="editClass('${className}', '${classData.color}')" 
                                        style="background: #ffc107; color: black; border: none; padding: 5px 10px; border-radius: 3px; cursor: pointer; font-size: 12px;">
                                    ✏️ Edit
                                </button>
                                <button onclick="deleteClass('${className}', ${driverCount})" 
                                        style="background: #dc3545; color: white; border: none; padding: 5px 10px; border-radius: 3px; cursor: pointer; font-size: 12px;"
                                        ${driverCount > 0 ? 'title="Warning: This class has drivers assigned"' : ''}>
                                    🗑️ Delete
                                </button>
                            </div>
                        </div>
                    `;
                });
                
                classesHTML += '</div>';
            }
            
            // Show drivers without class assignments
            if (driversWithoutClass && driversWithoutClass.length > 0) {
                classesHTML += `
                    <h4 style="margin-top: 30px; color: #dc3545;">⚠️ Drivers Without Class Assignment</h4>
                    <div style="background: #fff3cd; border: 1px solid #ffeaa7; padding: 10px; border-radius: 5px; margin-bottom: 15px;">
                        <strong>Note:</strong> These drivers have no [ClassName] in their iRacing nickname and no manual class assignments.
                    </div>
                    <div style="display: grid; gap: 5px;">
                        ${driversWithoutClass.map(driver => `
                            <div class="driver-reassign-item">
                                <div>
                                    <strong>${driver.display_name}</strong>
                                    <small style="color: #666; margin-left: 10px;">ID: ${driver.cust_id}</small>
                                </div>
                                <div style="display: flex; gap: 5px; align-items: center;">
                                    <select id="assignClass_${driver.cust_id}" style="padding: 3px; font-size: 12px;">
                                        <option value="">-- Select Class --</option>
                                        ${Object.keys(classes).map(className => `
                                            <option value="${className}">${className}</option>
                                        `).join('')}
                                    </select>
                                    <button onclick="assignClassToDriver('${driver.cust_id}', '${driver.display_name}')" 
                                            style="background: #28a745; color: white; border: none; padding: 3px 8px; border-radius: 3px; cursor: pointer; font-size: 11px;">
                                        Assign
                                    </button>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
            }
            
            contentDiv.innerHTML = classesHTML;
        }

        function toggleChampionshipView(viewType) {
            // Reset all buttons
            ['enhancedViewBtn', 'simpleViewBtn', 'detailedViewBtn', 'statsViewBtn'].forEach(id => {
                const btn = document.getElementById(id);
                if (btn) btn.classList.remove('active');
            });
            
            // Activate selected button
            const activeBtn = document.getElementById(viewType + 'ViewBtn');
            if (activeBtn) activeBtn.classList.add('active');
            
            // Show appropriate view
            switch(viewType) {
                case 'enhanced':
                    showEnhancedChampionshipView(window.currentChampionshipData);
                    break;
                case 'simple':
                    showSimpleChampionshipView(window.currentChampionshipData);
                    break;
                case 'detailed':
                    showDetailedChampionshipView(window.currentChampionshipData);
                    break;
                case 'stats':
                    showStatsChampionshipView(window.currentChampionshipData);
                    break;
            }
        }

        function showEnhancedChampionshipView(data) {
            const contentDiv = document.getElementById('championshipContent');
            const standingsToShow = { [currentDivisionFilter]: data.standings[currentDivisionFilter] };
            
            let contentHTML = '';
            Object.entries(standingsToShow).forEach(([division, drivers]) => {
                if (!drivers || drivers.length === 0) {
                    contentHTML = `<div style="text-align: center; padding: 40px; color: #6c757d;">
                        <h3>No drivers found in ${division} division</h3>
                        <p>This division may not have any drivers assigned or races completed.</p>
                    </div>`;
                    return;
                }
                
                // Calculate division statistics
                const totalDrivers = drivers.length;
                const totalRaces = Math.max(...drivers.map(d => d.races.length));
                const avgPointsPerRace = drivers.reduce((sum, d) => sum + (d.total_points / Math.max(d.races.length, 1)), 0) / totalDrivers;
                const topPoints = drivers[0]?.total_points || 0;
                const pointsGap = drivers.length > 1 ? topPoints - drivers[1].total_points : 0;
                
                contentHTML += `
                    <div style="background: linear-gradient(135deg, #ff6b6b 0%, #feca57 100%); color: white; border-radius: 15px; padding: 25px; margin-bottom: 25px; box-shadow: 0 8px 25px rgba(0,0,0,0.15);">
                        <h2 style="margin: 0 0 20px 0; font-size: 1.8em; text-align: center;">
                            ${division === 'Overall' ? '🏆 Overall Championship (All Drivers)' : `🏁 ${division} Championship`}
                        </h2>
                        
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-bottom: 20px; text-align: center;">
                            <div style="background: rgba(255,255,255,0.2); padding: 15px; border-radius: 10px;">
                                <div style="font-size: 2em; font-weight: bold;">${totalDrivers}</div>
                                <div style="font-size: 0.9em; opacity: 0.9;">Drivers</div>
                            </div>
                            <div style="background: rgba(255,255,255,0.2); padding: 15px; border-radius: 10px;">
                                <div style="font-size: 2em; font-weight: bold;">${totalRaces}</div>
                                <div style="font-size: 0.9em; opacity: 0.9;">Max Races</div>
                            </div>
                            <div style="background: rgba(255,255,255,0.2); padding: 15px; border-radius: 10px;">
                                <div style="font-size: 2em; font-weight: bold;">${avgPointsPerRace.toFixed(1)}</div>
                                <div style="font-size: 0.9em; opacity: 0.9;">Avg Pts/Race</div>
                            </div>
                            <div style="background: rgba(255,255,255,0.2); padding: 15px; border-radius: 10px;">
                                <div style="font-size: 2em; font-weight: bold;">${pointsGap}</div>
                                <div style="font-size: 0.9em; opacity: 0.9;">Points Gap</div>
                            </div>
                        </div>
                        ${division === 'Overall' ? `
                        <div style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 10px; margin-top: 15px;">
                            <strong>ℹ️ Overall Championship:</strong> Includes all drivers regardless of class. Drivers may compete in multiple classes simultaneously.
                        </div>
                        ` : ''}
                    </div>
                    
                    <div style="background: white; border-radius: 15px; overflow: hidden; box-shadow: 0 8px 25px rgba(0,0,0,0.1); margin-bottom: 30px;">
                        <table class="results-table" style="margin: 0; border-radius: 15px;">
                            <thead>
                                <tr style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                                    <th style="text-align: center; padding: 20px 15px;">Position</th>
                                    <th style="padding: 20px 15px;">Driver Details</th>
                                    <th style="text-align: center; padding: 20px 15px;">Performance</th>
                                    <th style="text-align: center; padding: 20px 15px;">Race Stats</th>
                                    <th style="text-align: center; padding: 20px 15px;">Bonuses & Penalties</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${drivers.map((driver, index) => {
                                    const raceCount = driver.races.length;
                                    const avgPoints = raceCount > 0 ? (driver.total_points / raceCount).toFixed(1) : '0.0';
                                    const bestFinish = Math.min(...driver.races.map(r => Math.round(r.division_position)));
                                    const worstFinish = Math.max(...driver.races.map(r => Math.round(r.division_position)));
                                    const avgFinish = raceCount > 0 ? Math.round(driver.races.reduce((sum, r) => sum + Math.round(r.division_position), 0) / raceCount) : 'N/A';
                                    
                                    const fastestLaps = driver.races.filter(r => r.fastest_lap).length;
                                    const poles = driver.races.filter(r => r.pole_position).length;
                                    const totalPenaltyPoints = driver.races.reduce((sum, r) => sum + (r.penalty_points || 0), 0);
                                    const penaltyCount = driver.races.filter(r => r.penalty_points > 0).length;
                                    
                                    const droppedRaces = driver.races.filter(r => r.dropped).length;
                                    const pointsFromDropped = driver.races.filter(r => r.dropped).reduce((sum, r) => sum + r.points, 0);
                                    
                                    // Position styling
                                    let positionStyle = 'font-size: 1.5em; font-weight: bold; padding: 15px; text-align: center; border-radius: 10px; margin: 5px;';
                                    let positionBg = '#6c757d';
                                    if (index === 0) positionBg = 'linear-gradient(135deg, #ffd700 0%, #ffed4e 100%)';
                                    else if (index === 1) positionBg = 'linear-gradient(135deg, #c0c0c0 0%, #e8e8e8 100%)';
                                    else if (index === 2) positionBg = 'linear-gradient(135deg, #cd7f32 0%, #daa520 100%)';
                                    else if (index < 5) positionBg = 'linear-gradient(135deg, #28a745 0%, #20c997 100%)';
                                    
                                    // Show multiple classes for Overall championship
                                    let classInfo = '';
                                    if (division === 'Overall' && driver.multiple_classes && driver.all_classes) {
                                        classInfo = `<br><small style="color: #17a2b8;">Classes: ${driver.all_classes.join(', ')}</small>`;
                                    } else if (division === 'Overall' && driver.primary_class) {
                                        classInfo = `<br><small style="color: #6c757d;">Primary: ${driver.primary_class}</small>`;
                                    }
                                    
                                    // Find most commonly used car
                                    const carUsage = {};
                                    driver.races.forEach(race => {
                                        const carName = race.car_name || 'Unknown Car';
                                        carUsage[carName] = (carUsage[carName] || 0) + 1;
                                    });
                                    const mostUsedCar = Object.entries(carUsage).sort((a, b) => b[1] - a[1])[0];
                                    const carInfo = mostUsedCar ? mostUsedCar[0] : 'Unknown Car';
                                    const carChanges = Object.keys(carUsage).length > 1 ? ` (${Object.keys(carUsage).length} different cars)` : '';
                                    
                                    return `
                                        <tr style="border-bottom: 2px solid #f8f9fa; transition: all 0.3s ease;" onmouseover="this.style.background='#f8f9fa'" onmouseout="this.style.background='white'">
                                            <td style="text-align: center; padding: 20px 15px;">
                                                <div style="${positionStyle} background: ${positionBg}; color: ${index < 3 ? 'black' : 'white'};">
                                                    ${driver.championship_position}
                                                    ${index === 0 ? '<br>👑' : index === 1 ? '<br>🥈' : index === 2 ? '<br>🥉' : ''}
                                                </div>
                                            </td>
                                            <td style="padding: 20px 15px;">
                                                <div style="font-size: 1.2em; font-weight: bold; color: #2c3e50; margin-bottom: 8px;">
                                                    ${driver.display_name}
                                                </div>
                                                <div style="color: #6c757d; font-size: 0.9em;">
                                                    <strong>Car #:</strong> ${driver.car_number || 'N/A'}<br>
                                                    <strong>Primary Car:</strong> ${carInfo}${carChanges}<br>
                                                    <strong>Customer ID:</strong> ${driver.cust_id}${classInfo}
                                                </div>
                                            </td>
                                            <td style="text-align: center; padding: 20px 15px;">
                                                <div style="font-size: 1.8em; font-weight: bold; color: #2c3e50; margin-bottom: 10px;">
                                                    ${driver.total_points}
                                                </div>
                                                <div style="font-size: 0.9em; color: #6c757d;">
                                                    <strong>Avg:</strong> ${avgPoints} pts/race<br>
                                                    ${droppedRaces > 0 ? `<span style="color: #dc3545;"><strong>Dropped:</strong> ${pointsFromDropped} pts</span>` : ''}
                                                </div>
                                            </td>
                                            <td style="text-align: center; padding: 20px 15px;">
                                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; font-size: 0.9em;">
                                                    <div><strong>Races:</strong> ${raceCount}</div>
                                                    <div><strong>Best:</strong> P${bestFinish}</div>
                                                    <div><strong>Worst:</strong> P${worstFinish}</div>
                                                    <div><strong>Avg:</strong> P${avgFinish}</div>
                                                </div>
                                            </td>
                                            <td style="text-align: center; padding: 20px 15px;">
                                                <div style="display: flex; flex-direction: column; gap: 8px; font-size: 0.9em;">
                                                    ${fastestLaps > 0 ? `<div style="background: #28a745; color: white; padding: 4px 8px; border-radius: 15px;">⚡ ${fastestLaps} Fastest Lap${fastestLaps > 1 ? 's' : ''}</div>` : ''}
                                                    ${poles > 0 ? `<div style="background: #ffc107; color: black; padding: 4px 8px; border-radius: 15px;">🏁 ${poles} Pole${poles > 1 ? 's' : ''}</div>` : ''}
                                                    ${penaltyCount > 0 ? `<div style="background: #dc3545; color: white; padding: 4px 8px; border-radius: 15px;">⚠️ ${penaltyCount} Penalt${penaltyCount > 1 ? 'ies' : 'y'} (-${totalPenaltyPoints}pts)</div>` : ''}
                                                    ${fastestLaps === 0 && poles === 0 && penaltyCount === 0 ? '<div style="color: #6c757d;">No bonuses/penalties</div>' : ''}
                                                </div>
                                            </td>
                                        </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
            });
            
            contentDiv.innerHTML = contentHTML;
        }

        function showStatsChampionshipView(data) {
            const contentDiv = document.getElementById('championshipContent');
            const standingsToShow = { [currentDivisionFilter]: data.standings[currentDivisionFilter] };
            
            let contentHTML = '';
            Object.entries(standingsToShow).forEach(([division, drivers]) => {
                if (!drivers || drivers.length === 0) {
                    contentHTML = `<div style="text-align: center; padding: 40px; color: #6c757d;">
                        <h3>No drivers found in ${division} division</h3>
                        <p>This division may not have any drivers assigned or races completed.</p>
                    </div>`;
                    return;
                }
                
                // Calculate comprehensive statistics
                const allRaces = [];
                const raceMap = new Map();
                
                drivers.forEach(driver => {
                    driver.races.forEach(race => {
                        const raceKey = race.subsession_id || race.session_name;
                        if (!raceMap.has(raceKey)) {
                            raceMap.set(raceKey, {
                                id: raceKey,
                                name: race.session_name || 'Race',
                                track: race.track_name || 'Unknown Track',
                                date: race.date,
                                participants: 0,
                                avgPoints: 0,
                                fastestLapWinner: null,
                                poleWinner: null
                            });
                            allRaces.push(raceMap.get(raceKey));
                        }
                    });
                });
                
                // Calculate race statistics
                allRaces.forEach(race => {
                    const raceResults = [];
                    drivers.forEach(driver => {
                        const driverRace = driver.races.find(r => (r.subsession_id || r.session_name) === race.id);
                        if (driverRace) {
                            raceResults.push(driverRace);
                            if (driverRace.fastest_lap) race.fastestLapWinner = driver.display_name;
                            if (driverRace.pole_position) race.poleWinner = driver.display_name;
                        }
                    });
                    race.participants = raceResults.length;
                    race.avgPoints = raceResults.length > 0 ? raceResults.reduce((sum, r) => sum + r.points, 0) / raceResults.length : 0;
                });
                
                allRaces.sort((a, b) => new Date(a.date) - new Date(b.date));
                
                contentHTML += `
                    <div style="background: linear-gradient(135deg, #6f42c1 0%, #e83e8c 100%); color: white; border-radius: 15px; padding: 25px; margin-bottom: 25px;">
                        <h2 style="margin: 0 0 20px 0; text-align: center;">📈 ${division} Championship Statistics</h2>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 30px;">
                        <!-- Race-by-Race Breakdown -->
                        <div style="background: white; border-radius: 15px; padding: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
                            <h4 style="margin: 0 0 15px 0; color: #495057;">🏁 Race-by-Race Breakdown</h4>
                            <div style="max-height: 400px; overflow-y: auto;">
                                ${allRaces.map((race, index) => `
                                    <div style="border: 1px solid #dee2e6; border-radius: 8px; padding: 15px; margin-bottom: 10px; background: #f8f9fa;">
                                        <div style="font-weight: bold; color: #2c3e50; margin-bottom: 8px;">
                                            Round ${index + 1}: ${race.track}
                                        </div>
                                        <div style="font-size: 0.9em; color: #6c757d;">
                                            <strong>Participants:</strong> ${race.participants}<br>
                                            <strong>Avg Points:</strong> ${race.avgPoints.toFixed(1)}<br>
                                            ${race.poleWinner ? `<strong>Pole:</strong> ${race.poleWinner}<br>` : ''}
                                            ${race.fastestLapWinner ? `<strong>Fastest Lap:</strong> ${race.fastestLapWinner}` : ''}
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                        
                        <!-- Driver Performance Stats -->
                        <div style="background: white; border-radius: 15px; padding: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
                            <h4 style="margin: 0 0 15px 0; color: #495057;">🏆 Performance Leaders</h4>
                            
                            <!-- Most Consistent (lowest avg finish position) -->
                            <div style="margin-bottom: 20px;">
                                <h5 style="color: #28a745; margin-bottom: 10px;">🎯 Most Consistent</h5>
                                ${drivers.slice(0, 5).map(driver => {
                                    const avgFinish = driver.races.length > 0 ? Math.round(driver.races.reduce((sum, r) => sum + Math.round(r.division_position), 0) / driver.races.length) : 'N/A';
                                    return `<div style="display: flex; justify-content: space-between; padding: 5px 0; border-bottom: 1px solid #eee;">
                                        <span>${driver.display_name}</span>
                                        <span style="font-weight: bold;">P${avgFinish}</span>
                                    </div>`;
                                }).join('')}
                            </div>
                            
                            <!-- Most Fastest Laps -->
                            <div style="margin-bottom: 20px;">
                                <h5 style="color: #ffc107; margin-bottom: 10px;">⚡ Fastest Lap Masters</h5>
                                ${drivers
                                    .map(driver => ({
                                        ...driver,
                                        fastestLaps: driver.races.filter(r => r.fastest_lap).length
                                    }))
                                    .sort((a, b) => b.fastestLaps - a.fastestLaps)
                                    .slice(0, 5)
                                    .map(driver => `<div style="display: flex; justify-content: space-between; padding: 5px 0; border-bottom: 1px solid #eee;">
                                        <span>${driver.display_name}</span>
                                        <span style="font-weight: bold;">${driver.fastestLaps}</span>
                                    </div>`).join('')}
                            </div>
                            
                            <!-- Most Poles -->
                            <div>
                                <h5 style="color: #17a2b8; margin-bottom: 10px;">🏁 Pole Position Kings</h5>
                                ${drivers
                                    .map(driver => ({
                                        ...driver,
                                        poles: driver.races.filter(r => r.pole_position).length
                                    }))
                                    .sort((a, b) => b.poles - a.poles)
                                    .slice(0, 5)
                                    .map(driver => `<div style="display: flex; justify-content: space-between; padding: 5px 0; border-bottom: 1px solid #eee;">
                                        <span>${driver.display_name}</span>
                                        <span style="font-weight: bold;">${driver.poles}</span>
                                    </div>`).join('')}
                            </div>
                        </div>
                    </div>
                `;
            });
            
            contentDiv.innerHTML = contentHTML;
        }

        function filterByDivision(division) {
            currentDivisionFilter = division;
            if (currentLeagueId && currentSeasonId) {
                loadFromDatabase('championship');
            }
        }

        // Points configuration functions
        async function togglePointsConfig() {
            const section = document.getElementById('pointsConfigSection');
            const isVisible = section.style.display !== 'none';
            
            if (isVisible) {
                section.style.display = 'none';
            } else {
                section.style.display = 'block';
                await loadPointsConfigInterface();
            }
        }

        async function loadPointsConfigForLeague(leagueId) {
            try {
                const response = await fetch(`/api/league/${leagueId}/points-config`, {
                    credentials: 'include'
                });
                
                if (response.ok) {
                    const data = await response.json();
                    currentPointsConfig = data;
                }
            } catch (error) {
                console.error('Error loading points config:', error);
            }
        }

        async function loadPointsConfigInterface() {
            if (!currentLeagueId) {
                alert('Please select a league first');
                return;
            }

            try {
                const response = await fetch(`/api/league/${currentLeagueId}/points-config`, {
                    credentials: 'include'
                });
                
                if (!response.ok) {
                    throw new Error('Failed to load points configuration');
                }
                
                const data = await response.json();
                
                // Populate form
                document.getElementById('pointsConfigName').value = data.config.name || '';
                document.getElementById('dropWeeks').value = data.config.dropWeeks || 2;
                document.getElementById('fastestLapPoints').value = data.config.fastestLapPoints || 1;
                document.getElementById('polePositionPoints').value = data.config.polePositionPoints || 1;
                
                // Populate presets dropdown
                const presetSelect = document.getElementById('pointsPreset');
                presetSelect.innerHTML = '<option value="">-- Select Preset --</option>';
                Object.entries(data.presets).forEach(([key, preset]) => {
                    const option = document.createElement('option');
                    option.value = key;
                    option.textContent = `${preset.name} (${preset.dropWeeks || 0} drops, ${preset.fastestLapPoints || 0}pt FL, ${preset.polePositionPoints || 0}pt Pole)`;
                    presetSelect.appendChild(option);
                });
                
                // Generate points editor
                generatePointsEditor(data.config.points);
                
            } catch (error) {
                console.error('Error loading points config interface:', error);
                alert('Error loading points configuration');
            }
        }

        function generatePointsEditor(points) {
            const editor = document.getElementById('pointsEditor');
            editor.innerHTML = '';
            
            // Ensure we have at least 20 positions
            const maxPosition = Math.max(20, Math.max(...Object.keys(points).map(Number)));
            
            for (let pos = 1; pos <= maxPosition; pos++) {
                const div = document.createElement('div');
                div.className = 'points-row';
                div.innerHTML = `
                    <label>${pos}:</label>
                    <input type="number" name="position_${pos}" value="${points[pos] || ''}" min="0" placeholder="0">
                `;
                editor.appendChild(div);
            }
        }

        function addMorePositions() {
            const editor = document.getElementById('pointsEditor');
            const currentRows = editor.children.length;
            
            for (let i = 1; i <= 10; i++) {
                const pos = currentRows + i;
                const div = document.createElement('div');
                div.className = 'points-row';
                div.innerHTML = `
                    <label>${pos}:</label>
                    <input type="number" name="position_${pos}" value="" min="0" placeholder="0">
                `;
                editor.appendChild(div);
            }
        }

        function loadPointsPreset() {
            const presetKey = document.getElementById('pointsPreset').value;
            if (!presetKey || !currentPointsConfig) return;
            
            const preset = currentPointsConfig.presets[presetKey];
            if (!preset) return;
            
            document.getElementById('pointsConfigName').value = preset.name;
            document.getElementById('dropWeeks').value = preset.dropWeeks || 2;
            document.getElementById('fastestLapPoints').value = preset.fastestLapPoints || 1;
            document.getElementById('polePositionPoints').value = preset.polePositionPoints || 1;
            generatePointsEditor(preset.points);
        }

        async function savePointsConfig() {
            if (!currentLeagueId) {
                alert('Please select a league first');
                return;
            }

            const name = document.getElementById('pointsConfigName').value.trim();
            const dropWeeks = parseInt(document.getElementById('dropWeeks').value) || 0;
            const fastestLapPoints = parseInt(document.getElementById('fastestLapPoints').value) || 0;
            const polePositionPoints = parseInt(document.getElementById('polePositionPoints').value) || 0;
            
            if (!name) {
                alert('Please enter a configuration name');
                return;
            }

            if (dropWeeks < 0) {
                alert('Drop weeks cannot be negative');
                return;
            }

            if (fastestLapPoints < 0) {
                alert('Fastest lap points cannot be negative');
                return;
            }

            if (polePositionPoints < 0) {
                alert('Pole position points cannot be negative');
                return;
            }

            // Collect points from form
            const points = {};
            const inputs = document.querySelectorAll('#pointsEditor input');
            
            inputs.forEach(input => {
                const position = parseInt(input.name.replace('position_', ''));
                const pointValue = parseInt(input.value);
                
                if (!isNaN(pointValue) && pointValue > 0) {
                    points[position] = pointValue;
                }
            });

            if (Object.keys(points).length === 0) {
                alert('Please set points for at least one position');
                return;
            }

            try {
                const response = await fetch(`/api/league/${currentLeagueId}/points-config`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ name, points, dropWeeks, fastestLapPoints, polePositionPoints }),
                    credentials: 'include'
                });

                const data = await response.json();

                if (response.ok) {
                    showStatus(document.getElementById('pointsConfigStatus'), 
                        `Points configuration saved! (${dropWeeks} drops, ${fastestLapPoints}pt fastest lap, ${polePositionPoints}pt pole)`, 'success');
                    currentPointsConfig = { config: data.config, presets: currentPointsConfig.presets };
                } else {
                    throw new Error(data.error || 'Failed to save configuration');
                }
            } catch (error) {
                console.error('Error saving points config:', error);
                showStatus(document.getElementById('pointsConfigStatus'), `Error: ${error.message}`, 'error');
            }
        }

        function formatLapTime(timeInMs) {
            if (!timeInMs || timeInMs <= 0) return 'N/A';
            
            const totalSeconds = timeInMs / 10000; // iRacing time is in 10000ths of a second
            const minutes = Math.floor(totalSeconds / 60);
            const seconds = (totalSeconds % 60).toFixed(3);
            
            return `${minutes}:${seconds.padStart(6, '0')}`;
        }

        function showStatus(element, message, type) {
            element.innerHTML = `<div class="status ${type}">${message}</div>`;
        }

        function showLoading(message = 'Loading...') {
            document.getElementById('resultsContainer').innerHTML = `
                <div class="loading">
                    <div class="spinner"></div>
                    <p>${message}</p>
                </div>
            `;
        }

        function hideLoading() {
            // Loading will be replaced by actual content
        }

        async function reassignDriverFromRoster(custId, driverName, currentClass) {
            const newClassSelect = document.getElementById(`rosterClass_${custId}`);
            const newClass = newClassSelect.value;
            
            if (!newClass) {
                console.log('Please select a new class');
                return;
            }
            
            if (newClass === currentClass) {
                console.log('Driver is already in that class');
                return;
            }
            
            // Proceed with reassignment without confirmation
            
            try {
                showLoading('Reassigning driver and updating data...');
                
                const response = await fetch(`/api/league/${currentLeagueId}/driver/${custId}/class`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ newClass }),
                    credentials: 'include'
                });
                
                const data = await response.json();
                
                if (response.ok && data.success) {
                    // Log success message
                    console.log(`✅ ${driverName} successfully reassigned from "${data.oldClass || 'No Class'}" to "${data.newClass}". Championship standings will be recalculated on next load.`);
                    
                    // Reset the dropdown
                    newClassSelect.value = '';
                    
                    // Refresh the roster data to show the change
                    await loadFromDatabase('roster');
                    
                } else {
                    throw new Error(data.error || 'Failed to reassign driver');
                }
                
            } catch (error) {
                console.error('Error reassigning driver:', error);
                hideLoading();
                console.error('Error reassigning driver: ' + error.message);
            }
        }

        function toggleCSVUpload() {
            const section = document.getElementById('csvUploadSection');
            const isVisible = section.style.display !== 'none';
            section.style.display = isVisible ? 'none' : 'block';
            
            if (!isVisible) {
                // Clear any previous status
                document.getElementById('csvUploadStatus').innerHTML = '';
                document.getElementById('csvFile').value = '';
            }
        }

        async function uploadCSV() {
            const fileInput = document.getElementById('csvFile');
            const file = fileInput.files[0];
            
            if (!file) {
                showStatus(document.getElementById('csvUploadStatus'), 'Please select a CSV file', 'error');
                return;
            }
            
            if (!file.name.toLowerCase().endsWith('.csv')) {
                showStatus(document.getElementById('csvUploadStatus'), 'Please select a valid CSV file', 'error');
                return;
            }
            
            const formData = new FormData();
            formData.append('csvFile', file);
            formData.append('leagueId', currentLeagueId);
            formData.append('seasonId', currentSeasonId);
            
            try {
                showStatus(document.getElementById('csvUploadStatus'), 'Uploading and processing CSV...', 'info');
                
                const response = await fetch('/api/league/penalties/upload-csv', {
                    method: 'POST',
                    body: formData,
                    credentials: 'include'
                });
                
                const data = await response.json();
                
                if (response.ok && data.success) {
                    const { processed, skipped, errors } = data.results;
                    let message = `✅ CSV processed successfully!\n`;
                    message += `• ${processed} penalties added\n`;
                    if (skipped > 0) message += `• ${skipped} entries skipped (warnings or invalid data)\n`;
                    if (errors.length > 0) {
                        message += `• ${errors.length} errors:\n`;
                        errors.forEach(error => {
                            message += `  - Line ${error.line}: ${error.message}\n`;
                        });
                    }
                    
                    showStatus(document.getElementById('csvUploadStatus'), message, 'success');
                    
                    // Clear form and hide section
                    setTimeout(() => {
                        toggleCSVUpload();
                        // Reload penalties section
                        loadPenaltiesManagementData();
                        
                        // If championship standings are currently displayed, refresh them
                        if (document.getElementById('displayType').value === 'championship') {
                            setTimeout(() => {
                                loadFromDatabase('championship');
                            }, 1000);
                        }
                    }, 3000);
                } else {
                    throw new Error(data.error || 'Failed to process CSV');
                }
            } catch (error) {
                console.error('Error uploading CSV:', error);
                showStatus(document.getElementById('csvUploadStatus'), `Error: ${error.message}`, 'error');
            }
        }

        function showSimpleChampionshipView(data) {
            const contentDiv = document.getElementById('championshipContent');
            const standingsToShow = { [currentDivisionFilter]: data.standings[currentDivisionFilter] };
            
            let contentHTML = '';
            Object.entries(standingsToShow).forEach(([division, drivers]) => {
                if (!drivers || drivers.length === 0) {
                    contentHTML = `<div style="text-align: center; padding: 40px; color: #6c757d;">
                        <h3>No drivers found in ${division} division</h3>
                        <p>This division may not have any drivers assigned or races completed.</p>
                    </div>`;
                    return;
                }
                
                contentHTML += `
                    <h3>🏁 ${division} Championship</h3>
                    <table class="results-table">
                        <thead>
                            <tr>
                                <th>Pos</th>
                                <th>Driver</th>
                                <th>Car #</th>
                                <th>Points</th>
                                <th>Races</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${drivers.map(driver => `
                                <tr>
                                    <td class="championship-position pos-${driver.championship_position}">${driver.championship_position}</td>
                                    <td><strong>${driver.display_name}</strong></td>
                                    <td>${driver.car_number || 'N/A'}</td>
                                    <td><strong>${driver.total_points}</strong></td>
                                    <td>${driver.races.length}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
            });
            
            contentDiv.innerHTML = contentHTML;
        }

        function showDetailedChampionshipView(data) {
            const contentDiv = document.getElementById('championshipContent');
            const standingsToShow = { [currentDivisionFilter]: data.standings[currentDivisionFilter] };
            
            let contentHTML = '';
            Object.entries(standingsToShow).forEach(([division, drivers]) => {
                if (!drivers || drivers.length === 0) {
                    contentHTML = `<div style="text-align: center; padding: 40px; color: #6c757d;">
                        <h3>No drivers found in ${division} division</h3>
                        <p>This division may not have any drivers assigned or races completed.</p>
                    </div>`;
                    return;
                }
                
                // Get all unique races
                const allRaces = [];
                const raceMap = new Map();
                
                drivers.forEach(driver => {
                    driver.races.forEach(race => {
                        const raceKey = race.subsession_id || race.session_name;
                        if (!raceMap.has(raceKey)) {
                            raceMap.set(raceKey, {
                                id: raceKey,
                                name: race.session_name || 'Race',
                                track: race.track_name || 'Unknown Track',
                                date: race.date
                            });
                            allRaces.push(raceMap.get(raceKey));
                        }
                    });
                });
                
                allRaces.sort((a, b) => new Date(a.date) - new Date(b.date));
                
                const raceHeaders = allRaces.map((race, index) => {
                    const shortTrack = race.track.length > 12 ? race.track.substring(0, 12) + '...' : race.track;
                    return `<th style="min-width: 60px; text-align: center;" title="${race.track}">R${index + 1}<br><small>${shortTrack}</small></th>`;
                }).join('');
                
                const dropWeeks = data.points_config?.dropWeeks || 0;
                const fastestLapPoints = data.points_config?.fastestLapPoints || 0;
                const polePositionPoints = data.points_config?.polePositionPoints || 0;
                
                contentHTML += `
                    <h3>🏁 ${division} Championship - Detailed Breakdown</h3>
                    ${dropWeeks > 0 || fastestLapPoints > 0 || polePositionPoints > 0 ? `<p style="color: #666; font-style: italic; margin-bottom: 10px;">
                        ${dropWeeks > 0 ? `<strong>Drop Weeks:</strong> ${dropWeeks} lowest scores dropped. Dropped scores shown with strikethrough.<br>` : ''}
                        ${fastestLapPoints > 0 ? `<strong>Fastest Lap:</strong> ${fastestLapPoints}pt bonus per race shown with ⚡ symbol.<br>` : ''}
                        ${polePositionPoints > 0 ? `<strong>Pole Position:</strong> ${polePositionPoints}pt bonus per race shown with 🏁 symbol.<br>` : ''}
                        <strong>Penalties:</strong> Shown with ⚠️ symbol and subtracted from total.
                    </p>` : ''}
                    <div style="overflow-x: auto; margin-bottom: 20px;">
                        <table class="results-table" style="min-width: 800px;">
                            <thead>
                                <tr>
                                    <th>Pos</th>
                                    <th style="min-width: 150px;">Driver</th>
                                    <th>Car #</th>
                                    <th>Total</th>
                                    ${raceHeaders}
                                </tr>
                            </thead>
                            <tbody>
                                ${drivers.map(driver => {
                                    const driverRaceResults = new Map();
                                    driver.races.forEach(race => {
                                        const raceKey = race.subsession_id || race.session_name;
                                        driverRaceResults.set(raceKey, race);
                                    });
                                    
                                    const raceCells = allRaces.map(race => {
                                        const result = driverRaceResults.get(race.id);
                                        if (result) {
                                            let cellContent = result.points.toString();
                                            let cellTitle = `P${result.division_position} - ${result.points} points`;
                                            let cellStyle = 'text-align: center; padding: 8px;';
                                            
                                            // Add bonuses and penalties
                                            if (result.fastest_lap) {
                                                cellContent += ' ⚡';
                                                cellTitle += ` + ${fastestLapPoints} fastest lap`;
                                            }
                                            if (result.pole_position) {
                                                cellContent += ' 🏁';
                                                cellTitle += ` + ${polePositionPoints} pole position`;
                                            }
                                            if (result.penalty_points > 0) {
                                                cellContent += ' ⚠️';
                                                cellTitle += ` - ${result.penalty_points} penalty`;
                                            }
                                            
                                            // Strike through if dropped
                                            if (result.dropped) {
                                                cellStyle += ' text-decoration: line-through; color: #999;';
                                                cellTitle += ' (DROPPED)';
                                            }
                                            
                                            // Color based on position
                                            if (result.division_position === 1) {
                                                cellStyle += ' background-color: #ffd700; font-weight: bold;';
                                            } else if (result.division_position === 2) {
                                                cellStyle += ' background-color: #e6e6fa; font-weight: bold;';
                                            } else if (result.division_position === 3) {
                                                cellStyle += ' background-color: #deb887; font-weight: bold;';
                                            }
                                            
                                            return `<td style="${cellStyle}" title="${cellTitle}">${cellContent}</td>`;
                                        } else {
                                            return `<td style="text-align: center; color: #ccc;">-</td>`;
                                        }
                                    }).join('');
                                    
                                    return `
                                        <tr>
                                            <td class="championship-position pos-${driver.championship_position}">${driver.championship_position}</td>
                                            <td><strong>${driver.display_name}</strong></td>
                                            <td>${driver.car_number || 'N/A'}</td>
                                            <td><strong>${driver.total_points}</strong></td>
                                            ${raceCells}
                                        </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
            });
            
            contentDiv.innerHTML = contentHTML;
        }

        // New functions for multiple class assignment system
        
        async function loadAvailableClasses() {
            try {
                const response = await fetch(`/api/league/${currentLeagueId}/classes`, {
                    credentials: 'include'
                });
                if (response.ok) {
                    const data = await response.json();
                    return data.classes || [];
                }
            } catch (error) {
                console.error('Error loading available classes:', error);
            }
            return [];
        }
        
        async function loadDriverClasses(custId) {
            try {
                const response = await fetch(`/api/league/${currentLeagueId}/driver/${custId}/classes`, {
                    credentials: 'include'
                });
                if (response.ok) {
                    const data = await response.json();
                    displayDriverClasses(custId, data.classes || []);
                }
            } catch (error) {
                console.error('Error loading driver classes:', error);
            }
        }
        
        function displayDriverClasses(custId, classes) {
            const container = document.getElementById(`driverClasses_${custId}`);
            if (!container) return;
            
            if (classes.length === 0) {
                // Check for nick_name class
                const nickNameClass = getNickNameClass(custId);
                if (nickNameClass) {
                    const isExcluded = nickNameClass.toUpperCase() === 'EXCLUDED' || 
                                     nickNameClass.toUpperCase() === 'EXCLUDE' ||
                                     nickNameClass.toUpperCase() === 'NON-COMPETING' ||
                                     nickNameClass.toUpperCase() === 'NON_COMPETING';
                    const bgColor = isExcluded ? '#000000' : '#6c757d';
                    const indicator = isExcluded ? '🚫 ' : '';
                    container.innerHTML = `<span style="background: ${bgColor}; color: white; padding: 2px 6px; border-radius: 3px; font-size: 11px; margin: 1px;">${indicator}[${nickNameClass}] (Automatic from iRacing API Roster Nickname)</span>`;
                } else {
                    container.innerHTML = '<span style="color: #666;">No classes assigned</span>';
                }
            } else {
                const classesHTML = classes.map(className => {
                    const isExcluded = className.toUpperCase() === 'EXCLUDED' || 
                                     className.toUpperCase() === 'EXCLUDE' ||
                                     className.toUpperCase() === 'NON-COMPETING' ||
                                     className.toUpperCase() === 'NON_COMPETING';
                    const bgColor = isExcluded ? '#000000' : '#17a2b8';
                    const indicator = isExcluded ? '🚫 ' : '';
                    
                    return `<span style="background: ${bgColor}; color: white; padding: 2px 6px; border-radius: 3px; font-size: 11px; margin: 1px; display: inline-block;">
                        ${indicator}${className}
                        <button onclick="removeClassFromDriver('${custId}', '${className}')" 
                                style="background: none; border: none; color: white; margin-left: 3px; cursor: pointer; font-size: 10px;">×</button>
                    </span>`;
                }).join(' ');
                
                // Also show nick_name class if different
                const nickNameClass = getNickNameClass(custId);
                let nickNameHTML = '';
                if (nickNameClass && !classes.includes(nickNameClass)) {
                    const isExcluded = nickNameClass.toUpperCase() === 'EXCLUDED' || 
                                     nickNameClass.toUpperCase() === 'EXCLUDE' ||
                                     nickNameClass.toUpperCase() === 'NON-COMPETING' ||
                                     nickNameClass.toUpperCase() === 'NON_COMPETING';
                    const bgColor = isExcluded ? '#000000' : '#6c757d';
                    const indicator = isExcluded ? '🚫 ' : '';
                    nickNameHTML = `<span style="background: ${bgColor}; color: white; padding: 2px 6px; border-radius: 3px; font-size: 11px; margin: 1px;">${indicator}[${nickNameClass}] (Automatic from iRacing API Roster Nickname)</span> `;
                }
                
                container.innerHTML = nickNameHTML + classesHTML;
            }
        }
        
        function getNickNameClass(custId) {
            // Find the driver in current roster and extract class from nick_name
            if (!currentRoster) return null;
            
            const driver = currentRoster.find(d => d.cust_id == custId);
            if (!driver) return null;
            
            const nickName = driver.nick_name || '';
            const divisionMatch = nickName.match(/\[([^\]]+)\]/);
            return divisionMatch ? divisionMatch[1] : null;
        }
        
        async function addClassToDriver(custId, driverName) {
            const classSelect = document.getElementById(`classSelect_${custId}`);
            const className = classSelect.value;
            
            if (!className) {
                alert('Please select a class to add');
                return;
            }
            
            try {
                const response = await fetch(`/api/league/${currentLeagueId}/driver/${custId}/classes`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ className }),
                    credentials: 'include'
                });
                
                const data = await response.json();
                
                if (response.ok && data.success) {
                    console.log(`✅ Class "${className}" added to ${driverName}`);
                    
                    // Reset the dropdown
                    classSelect.value = '';
                    
                    // Refresh the driver's class display
                    await loadDriverClasses(custId);
                    
                } else {
                    throw new Error(data.error || 'Failed to add class');
                }
            } catch (error) {
                console.error('Error adding class to driver:', error);
                alert('Error adding class: ' + error.message);
            }
        }
        
        async function removeClassFromDriver(custId, className) {
            if (!confirm(`Remove class "${className}" from this driver?`)) {
                return;
            }
            
            try {
                const response = await fetch(`/api/league/${currentLeagueId}/driver/${custId}/classes/${encodeURIComponent(className)}`, {
                    method: 'DELETE',
                    credentials: 'include'
                });
                
                const data = await response.json();
                
                if (response.ok && data.success) {
                    console.log(`✅ Class "${className}" removed from driver`);
                    
                    // Refresh the driver's class display
                    await loadDriverClasses(custId);
                    
                } else {
                    throw new Error(data.error || 'Failed to remove class');
                }
            } catch (error) {
                console.error('Error removing class from driver:', error);
                alert('Error removing class: ' + error.message);
            }
        }
        
        async function manageDriverClasses(custId, driverName) {
            // Open a modal or detailed view for managing all classes for this driver
            const response = await fetch(`/api/league/${currentLeagueId}/driver/${custId}/classes`, {
                credentials: 'include'
            });
            
            if (!response.ok) {
                alert('Error loading driver classes');
                return;
            }
            
            const data = await response.json();
            const currentClasses = data.classes || [];
            
            // Get all available classes
            const availableClasses = await loadAvailableClasses();
            
            // Create a simple prompt-based interface (could be enhanced with a modal)
            let message = `Manage classes for ${driverName}:\n\n`;
            message += `Current classes: ${currentClasses.length > 0 ? currentClasses.join(', ') : 'None'}\n\n`;
            message += `Available classes: ${availableClasses.map(c => c.name).join(', ')}\n\n`;
            message += `Enter class names to add (comma-separated), or leave empty to cancel:`;
            
            const input = prompt(message);
            if (input === null || input.trim() === '') return;
            
            const classesToAdd = input.split(',').map(c => c.trim()).filter(c => c);
            
            for (const className of classesToAdd) {
                if (!currentClasses.includes(className)) {
                    try {
                        await fetch(`/api/league/${currentLeagueId}/driver/${custId}/classes`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({ className }),
                            credentials: 'include'
                        });
                    } catch (error) {
                        console.error(`Error adding class ${className}:`, error);
                    }
                }
            }
            
            // Refresh the driver's class display
            await loadDriverClasses(custId);
        }

        function getClassColor(className) {
            // Default colors for common classes
            const defaultColors = {
                'GT3': '#e74c3c',
                'GT4': '#f39c12',
                'LMP1': '#9b59b6',
                'LMP2': '#3498db',
                'LMP3': '#1abc9c',
                'GTE': '#e67e22',
                'GTLM': '#34495e',
                'DPi': '#2ecc71',
                'ADMIN': '#dc3545',
                'BROADCASTER': '#6c757d',
                'EXCLUDED': '#000000',
                'EXCLUDE': '#000000',
                'NON-COMPETING': '#000000',
                'NON_COMPETING': '#000000'
            };
            
            return defaultColors[className] || '#28a745';
        }

        async function addNewClass() {
            const className = document.getElementById('newClassName').value.trim();
            const classColor = document.getElementById('newClassColor').value;
            
            if (!className) {
                alert('Please enter a class name');
                return;
            }
            
            try {
                const response = await fetch(`/api/league/${currentLeagueId}/classes`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ name: className, color: classColor }),
                    credentials: 'include'
                });
                
                const data = await response.json();
                
                if (response.ok && data.success) {
                    alert(`✅ Class "${className}" added successfully!`);
                    
                    // Clear form
                    document.getElementById('newClassName').value = '';
                    document.getElementById('newClassColor').value = '#28a745';
                    
                    // Refresh the display
                    await displayClassManagement();
                } else {
                    throw new Error(data.error || 'Failed to add class');
                }
            } catch (error) {
                console.error('Error adding class:', error);
                alert('Error adding class: ' + error.message);
            }
        }

        async function editClass(className, currentColor) {
            const newName = prompt(`Edit class name:`, className);
            if (newName === null || newName.trim() === '') return;
            
            const newColor = prompt(`Edit class color (hex code or color name):`, currentColor);
            if (newColor === null || newColor.trim() === '') return;
            
            try {
                const response = await fetch(`/api/league/${currentLeagueId}/classes/${encodeURIComponent(className)}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ name: newName.trim(), color: newColor.trim() }),
                    credentials: 'include'
                });
                
                const data = await response.json();
                
                if (response.ok && data.success) {
                    alert(`✅ Class updated successfully!`);
                    await displayClassManagement();
                } else {
                    throw new Error(data.error || 'Failed to update class');
                }
            } catch (error) {
                console.error('Error updating class:', error);
                alert('Error updating class: ' + error.message);
            }
        }

        async function deleteClass(className, driverCount) {
            const warningMessage = driverCount > 0 
                ? `⚠️ WARNING: Class "${className}" has ${driverCount} driver${driverCount !== 1 ? 's' : ''} assigned.\n\nDeleting this class will remove all driver assignments.\nAre you sure you want to continue?`
                : `Delete class "${className}"?`;
            
            if (!confirm(warningMessage)) {
                return;
            }
            
            try {
                const response = await fetch(`/api/league/${currentLeagueId}/classes/${encodeURIComponent(className)}`, {
                    method: 'DELETE',
                    credentials: 'include'
                });
                
                const data = await response.json();
                
                if (response.ok && data.success) {
                    alert(`✅ Class "${className}" deleted successfully!`);
                    
                    // Clear championship cache to ensure deleted class doesn't appear in standings
                    if (currentSeasonId) {
                        try {
                            await fetch(`/api/league/${currentLeagueId}/season/${currentSeasonId}/championship/cache`, {
                                method: 'DELETE',
                                credentials: 'include'
                            });
                            console.log('🗑️ Championship cache cleared after class deletion');
                        } catch (cacheError) {
                            console.log('Note: Could not clear championship cache:', cacheError.message);
                        }
                    }
                    
                    await displayClassManagement();
                } else {
                    throw new Error(data.error || 'Failed to delete class');
                }
            } catch (error) {
                console.error('Error deleting class:', error);
                alert('Error deleting class: ' + error.message);
            }
        }

        async function assignClassToDriver(custId, driverName) {
            const classSelect = document.getElementById(`assignClass_${custId}`);
            const className = classSelect.value;
            
            if (!className) {
                alert('Please select a class to assign');
                return;
            }
            
            try {
                const response = await fetch(`/api/league/${currentLeagueId}/driver/${custId}/classes`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ className }),
                    credentials: 'include'
                });
                
                const data = await response.json();
                
                if (response.ok && data.success) {
                    alert(`✅ Class "${className}" assigned to ${driverName}!`);
                    await displayClassManagement();
                } else {
                    throw new Error(data.error || 'Failed to assign class');
                }
            } catch (error) {
                console.error('Error assigning class:', error);
                alert('Error assigning class: ' + error.message);
            }
        }

        async function refreshData() {
            if (!currentLeagueId || !currentSeasonId) return;
            
            try {
                showLoading('Refreshing data from API...');
                
                // Force refresh from API
                await cacheSeasonData(currentLeagueId, currentSeasonId);
                
                // Reload current display
                const displayType = document.getElementById('displayType').value;
                await loadFromDatabase(displayType);
                
            } catch (error) {
                console.error('Error refreshing data:', error);
                hideLoading();
                alert('Error refreshing data: ' + error.message);
            }
        }

        async function clearCache() {
            if (!currentLeagueId || !currentSeasonId) {
                alert('Please select a league and season first.');
                return;
            }
            
            // Confirm with user
            if (!confirm('Are you sure you want to clear all cached data? This will remove all stored data and force fresh API calls.')) {
                return;
            }
            
            try {
                showLoading('Clearing cache...');
                
                const response = await fetch(`/api/league/${currentLeagueId}/season/${currentSeasonId}/cache`, {
                    method: 'DELETE',
                    credentials: 'include'
                });
                
                if (!response.ok) {
                    throw new Error('Failed to clear cache');
                }
                
                const data = await response.json();
                
                // Show success message
                alert(`Cache cleared successfully! Removed ${data.cleared_entries} cached entries.`);
                
                // Clear the last updated time display
                const lastUpdatedElement = document.getElementById('lastUpdated');
                lastUpdatedElement.textContent = '';
                
                hideLoading();
                
            } catch (error) {
                console.error('Error clearing cache:', error);
                hideLoading();
                alert('Error clearing cache: ' + error.message);
            }
        }

        function startAutoRefresh() {
            // Always enable auto-refresh every 15 minutes
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
            }
            
            autoRefreshInterval = setInterval(async () => {
                if (currentLeagueId && currentSeasonId) {
                    console.log('🔄 Auto-refreshing data...');
                    await cacheSeasonDataInBackground(currentLeagueId, currentSeasonId);
                }
            }, 15 * 60 * 1000); // 15 minutes
            
            console.log('✅ Auto-refresh enabled (every 15 minutes)');
        }

        function updateLastUpdatedTime(timestamp) {
            const lastUpdatedElement = document.getElementById('lastUpdated');
            if (timestamp) {
                const date = new Date(timestamp);
                lastUpdatedElement.textContent = `Last updated: ${date.toLocaleString()}`;
            }
        }

        function displayRoster(data) {
            const container = document.getElementById('resultsContainer');
            const title = document.getElementById('resultsTitle');
            
            title.textContent = '👥 League Roster';
            
            if (data && data.roster && data.roster.length > 0) {
                const roster = data.roster;
                
                // Count drivers by division/role
                const divisionCounts = {};
                roster.forEach(member => {
                    const nickName = member.nick_name || '';
                    const divisionMatch = nickName.match(/\[([^\]]+)\]/);
                    const division = divisionMatch ? divisionMatch[1] : 'No Division';
                    divisionCounts[division] = (divisionCounts[division] || 0) + 1;
                });
                
                // Create division summary with custom sorting (put ADMIN and BROADCASTER first)
                const divisionSummary = Object.entries(divisionCounts)
                    .sort(([a], [b]) => {
                        // Custom sort order: ADMIN, BROADCASTER, then alphabetical
                        const priority = { 'ADMIN': 1, 'BROADCASTER': 2 };
                        const aPriority = priority[a] || 999;
                        const bPriority = priority[b] || 999;
                        
                        if (aPriority !== bPriority) return aPriority - bPriority;
                        return a.localeCompare(b);
                    })
                    .map(([division, count]) => `<span style="margin-right: 15px;"><strong>[${division}]:</strong> ${count} ${count === 1 ? 'person' : 'people'}</span>`)
                    .join('');
                
                // Extract all classes for the assignment dropdown
                const allClasses = {};
                roster.forEach(member => {
                    const nickName = member.nick_name || '';
                    const divisionMatch = nickName.match(/\[([^\]]+)\]/);
                    if (divisionMatch) {
                        allClasses[divisionMatch[1]] = true;
                    }
                });
                
                // Load additional classes from database
                loadAvailableClasses().then(dbClasses => {
                    dbClasses.forEach(cls => {
                        allClasses[cls.name] = true;
                    });
                    
                    const classOptions = Object.keys(allClasses).map(className => 
                        `<option value="${className}">${className}</option>`
                    ).join('');

                    container.innerHTML = `
                        <p><strong>Total Members:</strong> ${roster.length}</p>
                        <div style="background: #e7f3ff; border: 1px solid #b3d7ff; border-radius: 5px; padding: 10px; margin-bottom: 15px;">
                            <strong>🏆 Division/Role Breakdown:</strong><br>
                            ${divisionSummary}
                        </div>
                        <div style="background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 5px; padding: 10px; margin-bottom: 15px;">
                            <strong>💡 Multiple Class Assignment System:</strong> Drivers can now be assigned to multiple classes (like tags). Use the "Manage Classes" button to add/remove class assignments. The "Overall" championship includes all drivers regardless of class.
                        </div>
                        <div style="background: #f8d7da; border: 1px solid #f5c6cb; border-radius: 5px; padding: 10px; margin-bottom: 15px;">
                            <strong>🚫 Excluded Drivers:</strong> Drivers with classes "EXCLUDED", "EXCLUDE", "NON-COMPETING", or "NON_COMPETING" are excluded from all championship calculations but can still participate in races.
                        </div>
                        <table class="results-table">
                            <thead>
                                <tr>
                                    <th>Driver</th>
                                    <th>Customer ID</th>
                                    <th>Car Number</th>
                                    <th>Classes/Divisions</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${roster.map(member => {
                                    const nickName = member.nick_name || '';
                                    const divisionMatch = nickName.match(/\[([^\]]+)\]/);
                                    const nickNameClass = divisionMatch ? divisionMatch[1] : null;
                                    
                                    // Check if driver is excluded
                                    const isExcluded = nickNameClass && (
                                        nickNameClass.toUpperCase() === 'EXCLUDED' || 
                                        nickNameClass.toUpperCase() === 'EXCLUDE' ||
                                        nickNameClass.toUpperCase() === 'NON-COMPETING' ||
                                        nickNameClass.toUpperCase() === 'NON_COMPETING'
                                    );
                                    
                                    const rowStyle = isExcluded ? 'background-color: #f8f9fa; opacity: 0.7;' : '';
                                    const excludedIndicator = isExcluded ? ' 🚫' : '';
                                    
                                    return `
                                        <tr style="${rowStyle}">
                                            <td><strong>${member.display_name || 'Unknown'}${excludedIndicator}</strong>${isExcluded ? '<br><small style="color: #dc3545;">Excluded from championships</small>' : ''}</td>
                                            <td>${member.cust_id || 'N/A'}</td>
                                            <td>${member.car_number || 'N/A'}</td>
                                            <td>
                                                <div id="driverClasses_${member.cust_id}">
                                                    ${nickNameClass ? `<span style="background: ${isExcluded ? '#000000' : '#28a745'}; color: white; padding: 2px 6px; border-radius: 3px; font-size: 11px; margin: 1px;">[${nickNameClass}] (Automatic from iRacing API Roster Nickname)</span>` : '<span style="color: #666;">No classes assigned</span>'}
                                                </div>
                                            </td>
                                            <td>
                                                <div style="display: flex; gap: 5px; align-items: center; flex-wrap: wrap;">
                                                    <select id="classSelect_${member.cust_id}" style="padding: 3px; font-size: 12px; min-width: 80px;">
                                                        <option value="">-- Select Class --</option>
                                                        ${classOptions}
                                                        <option value="EXCLUDED" style="background-color: #000000; color: white;">🚫 EXCLUDED (No Championships)</option>
                                                    </select>
                                                    <button onclick="addClassToDriver('${member.cust_id}', '${member.display_name}')" 
                                                            style="background: #28a745; color: white; border: none; padding: 3px 8px; border-radius: 3px; cursor: pointer; font-size: 11px;">
                                                        Add Class
                                                    </button>
                                                    <button onclick="manageDriverClasses('${member.cust_id}', '${member.display_name}')" 
                                                            style="background: #17a2b8; color: white; border: none; padding: 3px 8px; border-radius: 3px; cursor: pointer; font-size: 11px;">
                                                        Manage
                                                    </button>
                                                </div>
                                            </td>
                                        </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        </table>
                    `;
                    
                    // Load and display current class assignments for each driver
                    roster.forEach(member => {
                        loadDriverClasses(member.cust_id);
                    });
                });
            } else {
                container.innerHTML = '<p>No roster data available.</p>';
            }
        }

        function displayUpcomingSessions(sessions) {
            const container = document.getElementById('resultsContainer');
            const title = document.getElementById('resultsTitle');
            
            title.textContent = '📅 Upcoming Sessions';
            
            if (sessions && sessions.length > 0) {
                const now = new Date();
                const upcomingSessions = sessions.filter(session => {
                    const sessionDate = session.launch_at ? new Date(session.launch_at) : 
                                       session.start_time ? new Date(session.start_time) : null;
                    return sessionDate && sessionDate > now;
                });
                
                if (upcomingSessions.length > 0) {
                    const sessionsHTML = upcomingSessions.map(session => {
                        const sessionDate = session.launch_at ? new Date(session.launch_at) : 
                                           session.start_time ? new Date(session.start_time) : null;
                        
                        const dateStr = sessionDate ? sessionDate.toLocaleDateString() : 'Unknown Date';
                        const timeStr = sessionDate ? sessionDate.toLocaleTimeString() : 'Unknown Time';
                        
                        const trackName = session.track?.track_name || 
                                         session.track_name || 
                                         'Unknown Track';
                        
                        const sessionTitle = session.session_name || 
                                             session.private_session_name || 
                                             `Race at ${trackName}`;
                        
                        return `
                            <div class="session-item upcoming">
                                <h4>🕒 ${sessionTitle}</h4>
                                <div class="session-meta">
                                    <strong>Date:</strong> ${dateStr} at ${timeStr} | 
                                    <strong>Track:</strong> ${trackName}
                                    ${session.subsession_id ? ` | <strong>Session ID:</strong> ${session.subsession_id}` : ''}
                                </div>
                            </div>
                        `;
                    }).join('');
                    
                    container.innerHTML = sessionsHTML;
                } else {
                    container.innerHTML = '<p>No upcoming sessions found. All sessions may have already taken place.</p>';
                }
            } else {
                container.innerHTML = '<p>No sessions found.</p>';
            }
        }

        function displayPastSessions(sessions) {
            const container = document.getElementById('resultsContainer');
            const title = document.getElementById('resultsTitle');
            
            title.textContent = '🏁 Race Results - Select a Session';
            
            // Add instruction at the top
            const instructionDiv = document.createElement('div');
            instructionDiv.style.cssText = 'background: #fff3cd; border: 1px solid #ffeaa7; padding: 10px; border-radius: 5px; margin-bottom: 15px; color: #856404;';
            instructionDiv.innerHTML = '<strong>📋 Click on any completed session below to view its race results:</strong>';
            
            if (sessions && sessions.length > 0) {
                const sessionsHTML = sessions.map(session => {
                    const sessionDate = session.launch_at ? new Date(session.launch_at).toLocaleDateString() : 
                                       session.start_time ? new Date(session.start_time).toLocaleDateString() : 'Unknown Date';
                    
                    const trackName = session.track?.track_name || 
                                     session.track_name || 
                                     'Unknown Track';
                    
                    const sessionTitle = session.session_name || 
                                         session.private_session_name || 
                                         `Race at ${trackName}`;
                    
                    return `
                        <div class="session-item" onclick="loadSpecificSessionResults(${session.subsession_id})">
                            <h4>🏁 ${sessionTitle}</h4>
                            <div class="session-meta">
                                <strong>Date:</strong> ${sessionDate} | 
                                <strong>Track:</strong> ${trackName} | 
                                <strong>Participants:</strong> <span id="participants-${session.subsession_id}">Loading...</span>
                                ${session.subsession_id ? ` | <strong>Session ID:</strong> ${session.subsession_id}` : ''}
                            </div>
                        </div>
                    `;
                }).join('');
                
                container.innerHTML = instructionDiv.outerHTML + sessionsHTML;
                
                // Fetch participant counts in the background
                sessions.forEach(async (session) => {
                    try {
                        const response = await fetch(`/api/results/${session.subsession_id}?include_licenses=false`, {
                            credentials: 'include'
                        });
                        
                        if (response.ok) {
                            const data = await response.json();
                            if (data && data.session_results && data.session_results.length > 0) {
                                const participantCount = data.session_results[0].results.length;
                                const participantElement = document.getElementById(`participants-${session.subsession_id}`);
                                if (participantElement) {
                                    participantElement.textContent = participantCount;
                                }
                            } else {
                                const participantElement = document.getElementById(`participants-${session.subsession_id}`);
                                if (participantElement) {
                                    participantElement.textContent = 'Unknown';
                                }
                            }
                        } else {
                            const participantElement = document.getElementById(`participants-${session.subsession_id}`);
                            if (participantElement) {
                                participantElement.textContent = 'Unknown';
                            }
                        }
                    } catch (error) {
                        console.error('Error loading participant count for session:', session.subsession_id);
                        const participantElement = document.getElementById(`participants-${session.subsession_id}`);
                        if (participantElement) {
                            participantElement.textContent = 'Error';
                        }
                    }
                });
            } else {
                container.innerHTML = instructionDiv.outerHTML + '<p>No completed sessions found.</p>';
            }
        }

        function displaySessionResults(data) {
            const container = document.getElementById('resultsContainer');
            const title = document.getElementById('resultsTitle');
            
            title.innerHTML = '🏁 Race Results <button onclick="goBackToSessionList()" style="float: right; background: linear-gradient(135deg, #6c757d 0%, #495057 100%); color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; font-size: 14px;">← Back to Sessions</button>';
            
            if (data && data.session_results && data.session_results.length > 0) {
                // Log available session types for debugging
                const sessionTypes = data.session_results.map(s => s.simsession_name).join(', ');
                console.log(`📋 Available session types: ${sessionTypes}`);
                
                // Find the race session - must be exactly "RACE"
                const raceSession = data.session_results.find(s => 
                    s.simsession_name === "RACE"
                );
                
                if (!raceSession || !raceSession.results) {
                    container.innerHTML = '<p>No race results found. This session may only contain practice or qualifying data.</p>';
                    return;
                }
                
                const results = raceSession.results;
                const sessionName = data.session_name || data.private_session_name || 'Race Session';
                const trackName = data.track?.track_name || 'Unknown Track';
                const sessionDate = data.start_time ? new Date(data.start_time).toLocaleDateString() : 'Unknown Date';
                
                console.log(`✅ Displaying RACE session results with ${results.length} drivers`);
                
                container.innerHTML = `
                    <h3>${sessionName}</h3>
                    <p><strong>Track:</strong> ${trackName} | <strong>Date:</strong> ${sessionDate}</p>
                    <table class="results-table">
                        <thead>
                            <tr>
                                <th>Pos</th>
                                <th>Driver</th>
                                <th>Car Class</th>
                                <th>Car</th>
                                <th>Club</th>
                                <th>Grid</th>
                                <th>Laps</th>
                                <th>Best Lap</th>
                                <th>Avg Lap</th>
                                <th>Incidents</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${results.map((result, index) => `
                                <tr>
                                    <td class="position">${index + 1}</td>
                                    <td><strong>${result.display_name}</strong></td>
                                    <td>${result.car_class_name || 'N/A'}</td>
                                    <td>${result.car_name || 'N/A'}</td>
                                    <td>${result.club_name || 'N/A'}</td>
                                    <td>${result.starting_position + 1 || 'N/A'}</td>
                                    <td>${result.laps_complete}</td>
                                    <td>${formatLapTime(result.best_lap_time)}</td>
                                    <td>${formatLapTime(result.average_lap)}</td>
                                    <td>${result.incidents}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
            } else {
                container.innerHTML = '<p>No results data available.</p>';
            }
        }

        function goBackToSessionList() {
            // Go back to the race results session list
            document.getElementById('displayType').value = 'results';
            loadFromDatabase('results');
        }

        async function loadSpecificSessionResults(subsessionId) {
            showLoading('Loading race results...');
            
            try {
                // Try to get cached data first
                let response = await fetch(`/api/results/${subsessionId}?include_licenses=true&cached=true`, {
                    credentials: 'include'
                });
                
                if (!response.ok) {
                    // If cached data fails, try fresh API call
                    response = await fetch(`/api/results/${subsessionId}?include_licenses=true`, {
                        credentials: 'include'
                    });
                }
                
                if (!response.ok) {
                    throw new Error('Failed to load session results');
                }
                
                const data = await response.json();
                displaySessionResults(data);
                hideLoading();
                
            } catch (error) {
                console.error('Error loading session results:', error);
                hideLoading();
                alert('Error loading session results: ' + error.message);
            }
        }

        async function addPenalty() {
            const subsessionId = document.getElementById('penaltySession').value;
            const custId = document.getElementById('penaltyDriver').value;
            const penaltyPoints = parseInt(document.getElementById('penaltyPoints').value);
            const reason = document.getElementById('penaltyReason').value;
            
            console.log('Adding penalty:', { subsessionId, custId, penaltyPoints, reason });
            
            if (!subsessionId || !custId || isNaN(penaltyPoints) || penaltyPoints < 0) {
                showStatus(document.getElementById('penaltyStatus'), 'Please fill in all required fields with valid data', 'error');
                return;
            }

            try {
                showStatus(document.getElementById('penaltyStatus'), 'Adding penalty...', 'info');
                
                const response = await fetch(`/api/league/${currentLeagueId}/season/${currentSeasonId}/penalties`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ subsessionId, custId, penaltyPoints, reason }),
                    credentials: 'include'
                });

                console.log('Response status:', response.status);
                console.log('Response headers:', response.headers);
                
                if (!response.ok) {
                    // Try to get error message from response
                    let errorMessage;
                    try {
                        const errorData = await response.json();
                        errorMessage = errorData.error || `Server error: ${response.status}`;
                    } catch (jsonError) {
                        // If response isn't JSON, get text
                        const errorText = await response.text();
                        errorMessage = `Server error: ${response.status} - ${errorText}`;
                        console.error('Non-JSON error response:', errorText);
                    }
                    throw new Error(errorMessage);
                }

                const data = await response.json();
                console.log('Success response:', data);

                if (data.success) {
                    showStatus(document.getElementById('penaltyStatus'), 'Penalty added successfully!', 'success');
                    
                    // Clear form
                    document.getElementById('penaltySession').value = '';
                    document.getElementById('penaltyDriver').value = '';
                    document.getElementById('penaltyPoints').value = '';
                    document.getElementById('penaltyReason').value = '';
                    
                    // Reload penalties section
                    setTimeout(() => {
                        loadPenaltiesManagementData();
                    }, 1000);
                    
                    // If championship standings are currently displayed, refresh them
                    if (document.getElementById('displayType').value === 'championship') {
                        setTimeout(() => {
                            loadFromDatabase('championship');
                        }, 1500);
                    }
                } else {
                    throw new Error(data.error || 'Failed to add penalty');
                }
            } catch (error) {
                console.error('Error adding penalty:', error);
                showStatus(document.getElementById('penaltyStatus'), `Error: ${error.message}`, 'error');
            }
        }

        async function removePenalty(subsessionId, custId) {
            if (!confirm('Are you sure you want to remove this penalty?')) {
                return;
            }

            try {
                const response = await fetch(`/api/league/${currentLeagueId}/season/${currentSeasonId}/penalties/${subsessionId}/${custId}`, {
                    method: 'DELETE',
                    credentials: 'include'
                });

                if (response.ok) {
                    // Reload penalties section
                    await loadPenaltiesManagementData();
                    
                    // If championship standings are currently displayed, refresh them
                    if (document.getElementById('displayType').value === 'championship') {
                        setTimeout(() => {
                            loadFromDatabase('championship');
                        }, 500);
                    }
                } else {
                    alert('Failed to remove penalty');
                }
            } catch (error) {
                console.error('Error removing penalty:', error);
                alert('Error removing penalty');
            }
        }

        function displayChampionshipStandings(data) {
            const container = document.getElementById('resultsContainer');
            const title = document.getElementById('resultsTitle');
            
            title.textContent = '🏆 Championship Standings';
            
            if (!data.standings || Object.keys(data.standings).length === 0) {
                container.innerHTML = '<p>No championship data available. Make sure the season has completed races.</p>';
                return;
            }

            const pointsConfigName = data.points_config?.name || 'Unknown';
            const dropWeeks = data.points_config?.dropWeeks || 0;
            const fastestLapPoints = data.points_config?.fastestLapPoints || 0;
            const polePositionPoints = data.points_config?.polePositionPoints || 0;
            
            // Division filter - get all available divisions
            const divisions = data.all_divisions || Object.keys(data.standings);
            
            // Ensure "Overall" is first in the list if it exists
            const sortedDivisions = divisions.sort((a, b) => {
                if (a === 'Overall') return -1;
                if (b === 'Overall') return 1;
                return a.localeCompare(b);
            });
            
            // Create division tab navigation
            const divisionTabs = sortedDivisions.map(div => 
                `<button class="championship-tab ${currentDivisionFilter === div || (currentDivisionFilter === 'all' && div === 'Overall') ? 'active' : ''}" 
                         onclick="switchChampionshipTab('${div}')" 
                         data-division="${div}">
                    ${div === 'Overall' ? '🏆 Overall' : div}
                    <span class="tab-count">${data.standings[div] ? data.standings[div].length : 0}</span>
                </button>`
            ).join('');
            
            // Create view option tabs
            const viewTabs = `
                <button class="championship-tab active" onclick="switchChampionshipView('enhanced')" data-view="enhanced">
                    🚀 Enhanced
                </button>
                <button class="championship-tab" onclick="switchChampionshipView('simple')" data-view="simple">
                    📊 Simple
                </button>
                <button class="championship-tab" onclick="switchChampionshipView('detailed')" data-view="detailed">
                    📈 Detailed
                </button>
                <button class="championship-tab" onclick="switchChampionshipView('stats')" data-view="stats">
                    📈 Statistics
                </button>
                <button class="championship-tab" onclick="switchChampionshipView('cars')" data-view="cars">
                    🚗 Car Usage
                </button>
            `;
            
            let standingsHTML = `
                <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-radius: 10px; padding: 20px; margin-bottom: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
                    <h3 style="margin: 0 0 15px 0; font-size: 1.4em;">🏆 Championship Configuration</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 15px;">
                        <div><strong>📊 Points System:</strong><br>${pointsConfigName}</div>
                        ${dropWeeks > 0 ? `<div><strong>📉 Drop Weeks:</strong><br>${dropWeeks} lowest scores dropped</div>` : ''}
                        ${fastestLapPoints > 0 ? `<div><strong>⚡ Fastest Lap:</strong><br>+${fastestLapPoints} point(s) per race</div>` : ''}
                        ${polePositionPoints > 0 ? `<div><strong>🏁 Pole Position:</strong><br>+${polePositionPoints} point(s) per race</div>` : ''}
                        <div><strong>⚠️ Penalties:</strong><br>Included in calculations</div>
                    </div>
                </div>
                
                <!-- View Options Tabs -->
                <div class="championship-tabs-container">
                    <h4 style="margin: 0 0 10px 20px; color: #495057;">📋 View Options</h4>
                    <div class="championship-tabs">
                        ${viewTabs}
                    </div>
                </div>
                
                <!-- Division Tabs -->
                <div class="championship-tabs-container">
                    <h4 style="margin: 0 0 10px 20px; color: #495057;">🏁 Division Filter</h4>
                    <div class="championship-tabs">
                        ${divisionTabs}
                    </div>
                </div>
                
                <div id="championshipContent"></div>
            `;
            
            container.innerHTML = standingsHTML;
            
            // Store data globally for view switching
            window.currentChampionshipData = data;
            window.currentChampionshipView = 'enhanced';
            
            // Set initial active tab
            if (currentDivisionFilter === 'all' || !currentDivisionFilter) {
                currentDivisionFilter = sortedDivisions[0] || 'Overall';
            }
            
            // Show enhanced view by default
            showEnhancedChampionshipView(data);
        }

        function switchChampionshipView(viewType) {
            // Update active view tab
            document.querySelectorAll('[data-view]').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelector(`[data-view="${viewType}"]`).classList.add('active');
            
            // Store current view
            window.currentChampionshipView = viewType;
            
            // Show appropriate view
            switch(viewType) {
                case 'enhanced':
                    showEnhancedChampionshipView(window.currentChampionshipData);
                    break;
                case 'simple':
                    showSimpleChampionshipView(window.currentChampionshipData);
                    break;
                case 'detailed':
                    showDetailedChampionshipView(window.currentChampionshipData);
                    break;
                case 'stats':
                    showStatsChampionshipView(window.currentChampionshipData);
                    break;
                case 'cars':
                    showCarUsageChampionshipView(window.currentChampionshipData);
                    break;
            }
        }

        function switchChampionshipTab(division) {
            // Update active division tab
            document.querySelectorAll('[data-division]').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelector(`[data-division="${division}"]`).classList.add('active');
            
            // Update current filter
            currentDivisionFilter = division;
            
            // Refresh the current view with new division
            const currentView = window.currentChampionshipView || 'enhanced';
            switchChampionshipView(currentView);
        }

        function showCarUsageChampionshipView(data) {
            const contentDiv = document.getElementById('championshipContent');
            const standingsToShow = { [currentDivisionFilter]: data.standings[currentDivisionFilter] };
            
            let contentHTML = '';
            Object.entries(standingsToShow).forEach(([division, drivers]) => {
                if (!drivers || drivers.length === 0) {
                    contentHTML = `<div style="text-align: center; padding: 40px; color: #6c757d;">
                        <h3>No drivers found in ${division} division</h3>
                        <p>This division may not have any drivers assigned or races completed.</p>
                    </div>`;
                    return;
                }
                
                // Get all unique races
                const allRaces = [];
                const raceMap = new Map();
                
                drivers.forEach(driver => {
                    driver.races.forEach(race => {
                        const raceKey = race.subsession_id || race.session_name;
                        if (!raceMap.has(raceKey)) {
                            raceMap.set(raceKey, {
                                id: raceKey,
                                name: race.session_name || 'Race',
                                track: race.track_name || 'Unknown Track',
                                date: race.date
                            });
                            allRaces.push(raceMap.get(raceKey));
                        }
                    });
                });
                
                allRaces.sort((a, b) => new Date(a.date) - new Date(b.date));
                
                const raceHeaders = allRaces.map((race, index) => {
                    const shortTrack = race.track.length > 12 ? race.track.substring(0, 12) + '...' : race.track;
                    return `<th style="min-width: 120px; text-align: center;" title="${race.track}">R${index + 1}<br><small>${shortTrack}</small></th>`;
                }).join('');
                
                contentHTML += `
                    <div style="background: linear-gradient(135deg, #17a2b8 0%, #138496 100%); color: white; border-radius: 15px; padding: 25px; margin-bottom: 25px;">
                        <h2 style="margin: 0 0 20px 0; text-align: center;">🚗 ${division} Car Usage Analysis</h2>
                        <div style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 10px;">
                            <strong>ℹ️ Color Coding:</strong> 
                            <span style="background: #28a745; color: white; padding: 2px 8px; border-radius: 3px; margin: 0 5px;">First Car / Same as First</span>
                            <span style="background: #ffc107; color: black; padding: 2px 8px; border-radius: 3px; margin: 0 5px;">Different from First Car</span>
                            <span style="background: #dc3545; color: white; padding: 2px 8px; border-radius: 3px; margin: 0 5px;">DNP (Did Not Participate)</span>
                            <span style="background: #6c757d; color: white; padding: 2px 8px; border-radius: 3px; margin: 0 5px;">No Data</span>
                        </div>
                    </div>
                    
                    <div style="overflow-x: auto; margin-bottom: 20px;">
                        <table class="results-table" style="min-width: 800px;">
                            <thead>
                                <tr>
                                    <th>Pos</th>
                                    <th style="min-width: 150px;">Driver</th>
                                    <th>Points</th>
                                    ${raceHeaders}
                                </tr>
                            </thead>
                            <tbody>
                                ${drivers.map(driver => {
                                    const driverRaceResults = new Map();
                                    driver.races.forEach(race => {
                                        const raceKey = race.subsession_id || race.session_name;
                                        driverRaceResults.set(raceKey, race);
                                    });
                                    
                                    // STEP 1: Find THIS driver's actual first car (isolated scope)
                                    const thisDriverSortedRaces = [...driver.races].sort((a, b) => new Date(a.date) - new Date(b.date));
                                    let thisDriverFirstCarName = null;
                                    
                                    // Find first non-DNP race to establish first car
                                    for (const race of thisDriverSortedRaces) {
                                        const carName = race.car_name || 'Unknown Car';
                                        const didNotParticipate = race.attended === false || 
                                                               race.points === 0 ||
                                                               carName.toLowerCase().includes('did not participate') || 
                                                               carName.toLowerCase().includes('no car') ||
                                                               carName === 'Unknown Car' ||
                                                               race.division_position === null ||
                                                               race.division_position === 0;
                                        
                                        if (!didNotParticipate) {
                                            thisDriverFirstCarName = carName.replace(/\s+/g, ' ').trim().toLowerCase();
                                            console.log(`🎯 ${driver.display_name} - FIRST CAR SET TO: "${thisDriverFirstCarName}"`);
                                            break; // Found first car, stop looking
                                        }
                                    }
                                    
                                    // STEP 2: Build display cells for all races using THIS driver's first car
                                    const raceData = [];
                                    
                                    allRaces.forEach(race => {
                                        const result = driverRaceResults.get(race.id);
                                        if (result) {
                                            const carName = result.car_name || 'Unknown Car';
                                            const didNotParticipate = result.attended === false || 
                                                                   result.points === 0 ||
                                                                   carName.toLowerCase().includes('did not participate') || 
                                                                   carName.toLowerCase().includes('no car') ||
                                                                   carName === 'Unknown Car' ||
                                                                   result.division_position === null ||
                                                                   result.division_position === 0;
                                            
                                            if (didNotParticipate) {
                                                raceData.push({
                                                    content: 'DNP',
                                                    bgColor: '#dc3545',
                                                    textColor: 'white',
                                                    tooltip: 'Did Not Participate'
                                                });
                                            } else {
                                                const shortCarName = carName.length > 15 ? carName.substring(0, 15) + '...' : carName;
                                                const normalizedCarName = carName.replace(/\s+/g, ' ').trim().toLowerCase();
                                                
                                                // Debug the comparison using THIS driver's first car
                                                const isMatch = normalizedCarName === thisDriverFirstCarName;
                                                console.log(`🚗 ${driver.display_name} - Car: "${normalizedCarName}" vs First: "${thisDriverFirstCarName}" = ${isMatch}`);
                                                
                                                let bgColor, textColor;
                                                if (isMatch) {
                                                    // Same as driver's first car - green
                                                    bgColor = '#28a745';
                                                    textColor = 'white';
                                                    console.log(`✅ ${driver.display_name} - MATCH = GREEN (${bgColor})`);
                                                } else {
                                                    // Different from driver's first car - yellow
                                                    bgColor = '#ffc107';
                                                    textColor = 'black';
                                                    console.log(`⚠️ ${driver.display_name} - NO MATCH = YELLOW (${bgColor})`);
                                                }
                                                
                                                console.log(`🎨 ${driver.display_name} - Final colors: bg=${bgColor}, text=${textColor}`);
                                                
                                                raceData.push({
                                                    content: shortCarName,
                                                    bgColor: bgColor,
                                                    textColor: textColor,
                                                    tooltip: `${carName} (P${result.division_position}) | First car: ${thisDriverFirstCarName || 'None'} | Match: ${isMatch ? 'YES' : 'NO'} | Colors: ${bgColor}`
                                                });
                                            }
                                        } else {
                                            raceData.push({
                                                content: 'No Data',
                                                bgColor: '#6c757d',
                                                textColor: 'white',
                                                tooltip: 'No Data'
                                            });
                                        }
                                    });
                                    
                                    // Generate HTML from processed data
                                    const raceCells = raceData.map((cell, index) => {
                                        const htmlCell = `<td style="text-align: center; padding: 8px; font-size: 11px; color: ${cell.textColor}; background-color: ${cell.bgColor} !important;" title="${cell.tooltip}">${cell.content}</td>`;
                                        if (index < 3) { // Only log first few cells to avoid spam
                                            console.log(`🏗️ ${driver.display_name} Cell ${index}: ${cell.content} - HTML bg color: ${cell.bgColor} !important`);
                                        }
                                        return htmlCell;
                                    }).join('');
                                    
                                    return `
                                        <tr>
                                            <td class="championship-position pos-${driver.championship_position}">${driver.championship_position}</td>
                                            <td><strong>${driver.display_name}</strong></td>
                                            <td><strong>${driver.total_points}</strong></td>
                                            ${raceCells}
                                        </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- Car Usage Summary -->
                    <div style="background: white; border-radius: 15px; padding: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
                        <h4 style="margin: 0 0 15px 0; color: #495057;">🚗 Car Usage Summary</h4>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px;">
                            ${(() => {
                                // Calculate car usage statistics (excluding DNP races)
                                const carUsage = {};
                                const driverCarChanges = {};
                                
                                drivers.forEach(driver => {
                                    let firstCarName = null; // Track the FIRST car ever used, not last participated
                                    let changes = 0;
                                    
                                    // Sort driver's races by date to ensure chronological order
                                    const sortedRaces = [...driver.races].sort((a, b) => new Date(a.date) - new Date(b.date));
                                    
                                    sortedRaces.forEach(race => {
                                        const carName = race.car_name || 'Unknown Car';
                                        // Improved DNP detection - same as main table
                                        const didNotParticipate = race.attended === false || 
                                                               race.points === 0 ||
                                                               carName.toLowerCase().includes('did not participate') || 
                                                               carName.toLowerCase().includes('no car') ||
                                                               carName === 'Unknown Car' ||
                                                               race.division_position === null ||
                                                               race.division_position === 0;
                                        
                                        if (!didNotParticipate) {
                                            // Only count actual participated races
                                            if (!carUsage[carName]) {
                                                carUsage[carName] = { count: 0, drivers: new Set() };
                                            }
                                            carUsage[carName].count++;
                                            carUsage[carName].drivers.add(driver.display_name);
                                            
                                            // Use same simple normalization as main table
                                            const normalizedCarName = carName.replace(/\s+/g, ' ').trim().toLowerCase();
                                            
                                            if (firstCarName === null) {
                                                // First car they ever used - store it (normalized)
                                                firstCarName = normalizedCarName;
                                            } else if (normalizedCarName !== firstCarName) {
                                                // Car is different from FIRST car ever used
                                                changes++;
                                            }
                                        }
                                    });
                                    
                                    driverCarChanges[driver.display_name] = changes;
                                });
                                
                                // Most popular cars
                                const popularCars = Object.entries(carUsage)
                                    .sort((a, b) => b[1].count - a[1].count)
                                    .slice(0, 5);
                                
                                // Drivers with most car changes
                                const mostChanges = Object.entries(driverCarChanges)
                                    .sort((a, b) => b[1] - a[1])
                                    .slice(0, 5);
                                
                                return `
                                    <div>
                                        <h5 style="color: #17a2b8; margin-bottom: 10px;">🏆 Most Popular Cars</h5>
                                        ${popularCars.map(([car, data]) => `
                                            <div style="display: flex; justify-content: space-between; padding: 5px 0; border-bottom: 1px solid #eee;">
                                                <span title="${car}">${car.length > 20 ? car.substring(0, 20) + '...' : car}</span>
                                                <span style="font-weight: bold;">${data.count} uses</span>
                                            </div>
                                        `).join('')}
                                    </div>
                                    <div>
                                        <h5 style="color: #ffc107; margin-bottom: 10px;">🔄 Most Car Changes</h5>
                                        <small style="color: #666; display: block; margin-bottom: 10px;">
                                            (Only counting changes between participated races)
                                        </small>
                                        ${mostChanges.map(([driver, changes]) => `
                                            <div style="display: flex; justify-content: space-between; padding: 5px 0; border-bottom: 1px solid #eee;">
                                                <span>${driver}</span>
                                                <span style="font-weight: bold;">${changes} change${changes !== 1 ? 's' : ''}</span>
                                            </div>
                                        `).join('')}
                                    </div>
                                `;
                            })()}
                        </div>
                    </div>
                `;
            });
            
            contentDiv.innerHTML = contentHTML;
        }

        function filterByDivision(division) {
            // Legacy function - now just switches tabs
            if (division === 'all') {
                division = 'Overall';
            }
            switchChampionshipTab(division);
        }

        // New functions for multiple class assignment system
    </script>

    <script>
        function toggleWidgetPublisher() {
            const section = document.getElementById('widgetPublisherSection');
            const isVisible = section.style.display !== 'none';
            
            if (isVisible) {
                section.style.display = 'none';
            } else {
                if (!currentLeagueId || !currentSeasonId) {
                    alert('Please select a league and season first');
                    return;
                }
                
                section.style.display = 'block';
                loadWidgetPublisherData();
            }
        }

        async function loadWidgetPublisherData() {
            const container = document.getElementById('widgetPublisherContainer');
            
            if (!currentLeagueId || !currentSeasonId) {
                container.innerHTML = '<p>Please select a league and season first.</p>';
                return;
            }

            const baseUrl = window.location.origin;
            const params = new URLSearchParams({
                leagueId: currentLeagueId,
                seasonId: currentSeasonId,
                maxRows: '10',
                autoRefresh: '0'
            });

            // Generate iframe code
            const iframeUrl = `${baseUrl}/championship-widget?${params.toString()}`;
            const iframeCode = `<iframe src="${iframeUrl}" 
        width="100%" 
        height="600" 
        frameborder="0"
        style="border-radius: 8px;">
</iframe>`;

            // Generate JavaScript code
            const jsAttrs = [
                `data-league-id="${currentLeagueId}"`,
                `data-season-id="${currentSeasonId}"`,
                `data-max-rows="10"`,
                `data-auto-refresh="0"`
            ];

            const javascriptCode = `<!-- Include the widget script -->
<script src="${baseUrl}/championship-widget.js"><\/script>

<!-- Create a container for the widget -->
<div id="uksimracing-championship" 
     ${jsAttrs.join('\n     ')}>
</div>`;

            // Generate direct links
            const widgetUrl = `${baseUrl}/championship-widget?${params.toString()}`;
            const directLinks = `Standalone Widget: ${widgetUrl}

Widget JavaScript: ${baseUrl}/championship-widget.js`;

            container.innerHTML = `
                <div style="background: #e7f3ff; border: 1px solid #b3d7ff; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                    <h4 style="margin: 0 0 10px 0; color: #1e3c72;">🎯 Universal Championship Widget</h4>
                    <p style="margin: 0; color: #495057;">This widget includes built-in controls allowing viewers to:</p>
                    <ul style="margin: 10px 0 0 20px; color: #495057;">
                        <li>Switch between all championship views (Enhanced, Simple, Detailed, Statistics, Car Usage)</li>
                        <li>Filter by any division/class</li>
                        <li>View live standings that auto-update</li>
                        <li>See complete championship configuration and points breakdown</li>
                    </ul>
                </div>

                <div style="background: white; border-radius: 10px; padding: 20px; margin-bottom: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                    <h3>🖼️ iframe Embed Code</h3>
                    <p>Copy and paste this code into any HTML page to embed the interactive championship widget:</p>
                    <div style="background: #f8f9fa; border: 1px solid #e9ecef; border-radius: 8px; padding: 15px; font-family: 'Courier New', monospace; font-size: 13px; white-space: pre-wrap; overflow-x: auto; margin: 15px 0;">${iframeCode}</div>
                    <button onclick="copyWidgetCode('iframe')" style="background: linear-gradient(135deg, #17a2b8 0%, #138496 100%); color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; font-size: 12px;">📋 Copy Code</button>
                </div>

                <div style="background: white; border-radius: 10px; padding: 20px; margin-bottom: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                    <h3>⚡ JavaScript Widget Code</h3>
                    <p>Advanced integration option with full interactivity and customization:</p>
                    <div style="background: #f8f9fa; border: 1px solid #e9ecef; border-radius: 8px; padding: 15px; font-family: 'Courier New', monospace; font-size: 13px; white-space: pre-wrap; overflow-x: auto; margin: 15px 0;">${javascriptCode}</div>
                    <button onclick="copyWidgetCode('javascript')" style="background: linear-gradient(135deg, #17a2b8 0%, #138496 100%); color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; font-size: 12px;">📋 Copy Code</button>
                </div>

                <div style="background: white; border-radius: 10px; padding: 20px; margin-bottom: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                    <h3>🔗 Direct Links</h3>
                    <p>Standalone URLs for sharing, bookmarking, or direct access:</p>
                    <div style="background: #f8f9fa; border: 1px solid #e9ecef; border-radius: 8px; padding: 15px; font-family: 'Courier New', monospace; font-size: 13px; white-space: pre-wrap; overflow-x: auto; margin: 15px 0;">${directLinks}</div>
                    <button onclick="copyWidgetCode('links')" style="background: linear-gradient(135deg, #17a2b8 0%, #138496 100%); color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; font-size: 12px;">📋 Copy Links</button>
                </div>

                <div style="background: white; border-radius: 10px; padding: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                    <h3>👀 Live Preview</h3>
                    <p>This is how your widget will look when embedded:</p>
                    <div style="border: 2px dashed #ddd; border-radius: 8px; padding: 20px; background: #f8f9fa;">
                        <iframe src="${iframeUrl}" width="100%" height="600" frameborder="0" style="border-radius: 8px;"></iframe>
                    </div>
                </div>
            `;

            // Store the codes for copying
            window.widgetCodes = {
                iframe: iframeCode,
                javascript: javascriptCode,
                links: directLinks
            };
        }

        function copyWidgetCode(type) {
            const code = window.widgetCodes[type];
            if (!code) return;
            
            navigator.clipboard.writeText(code).then(() => {
                alert('Code copied to clipboard!');
            }).catch(() => {
                // Fallback for older browsers
                const textArea = document.createElement('textarea');
                textArea.value = code;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                alert('Code copied to clipboard!');
            });
        }
    </script>

    <script>
        function displayRosterInManagement(data) {
            const container = document.getElementById('rosterManagementContainer');
            
            if (data && data.roster && data.roster.length > 0) {
                const roster = data.roster;
                
                // Count drivers by division/role
                const divisionCounts = {};
                roster.forEach(member => {
                    const nickName = member.nick_name || '';
                    const divisionMatch = nickName.match(/\[([^\]]+)\]/);
                    const division = divisionMatch ? divisionMatch[1] : 'No Division';
                    divisionCounts[division] = (divisionCounts[division] || 0) + 1;
                });
                
                // Create division summary with custom sorting (put ADMIN and BROADCASTER first)
                const divisionSummary = Object.entries(divisionCounts)
                    .sort(([a], [b]) => {
                        // Custom sort order: ADMIN, BROADCASTER, then alphabetical
                        const priority = { 'ADMIN': 1, 'BROADCASTER': 2 };
                        const aPriority = priority[a] || 999;
                        const bPriority = priority[b] || 999;
                        
                        if (aPriority !== bPriority) return aPriority - bPriority;
                        return a.localeCompare(b);
                    })
                    .map(([division, count]) => `<span style="margin-right: 15px;"><strong>[${division}]:</strong> ${count} ${count === 1 ? 'person' : 'people'}</span>`)
                    .join('');
                
                // Extract all classes for the assignment dropdown
                const allClasses = {};
                roster.forEach(member => {
                    const nickName = member.nick_name || '';
                    const divisionMatch = nickName.match(/\[([^\]]+)\]/);
                    if (divisionMatch) {
                        allClasses[divisionMatch[1]] = true;
                    }
                });
                
                // Load additional classes from database
                loadAvailableClasses().then(dbClasses => {
                    dbClasses.forEach(cls => {
                        allClasses[cls.name] = true;
                    });
                    
                    const classOptions = Object.keys(allClasses).map(className => 
                        `<option value="${className}">${className}</option>`
                    ).join('');

                    container.innerHTML = `
                        <p><strong>Total Members:</strong> ${roster.length}</p>
                        <div style="background: #e7f3ff; border: 1px solid #b3d7ff; border-radius: 5px; padding: 10px; margin-bottom: 15px;">
                            <strong>🏆 Division/Role Breakdown:</strong><br>
                            ${divisionSummary}
                        </div>
                        <div style="background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 5px; padding: 10px; margin-bottom: 15px;">
                            <strong>💡 Multiple Class Assignment System:</strong> Drivers can now be assigned to multiple classes (like tags). Use the "Manage Classes" button to add/remove class assignments. The "Overall" championship includes all drivers regardless of class.
                        </div>
                        <div style="background: #f8d7da; border: 1px solid #f5c6cb; border-radius: 5px; padding: 10px; margin-bottom: 15px;">
                            <strong>🚫 Excluded Drivers:</strong> Drivers with classes "EXCLUDED", "EXCLUDE", "NON-COMPETING", or "NON_COMPETING" are excluded from all championship calculations but can still participate in races.
                        </div>
                        <table class="results-table">
                            <thead>
                                <tr>
                                    <th>Driver</th>
                                    <th>Customer ID</th>
                                    <th>Car Number</th>
                                    <th>Classes/Divisions</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${roster.map(member => {
                                    const nickName = member.nick_name || '';
                                    const divisionMatch = nickName.match(/\[([^\]]+)\]/);
                                    const nickNameClass = divisionMatch ? divisionMatch[1] : null;
                                    
                                    // Check if driver is excluded
                                    const isExcluded = nickNameClass && (
                                        nickNameClass.toUpperCase() === 'EXCLUDED' || 
                                        nickNameClass.toUpperCase() === 'EXCLUDE' ||
                                        nickNameClass.toUpperCase() === 'NON-COMPETING' ||
                                        nickNameClass.toUpperCase() === 'NON_COMPETING'
                                    );
                                    
                                    const rowStyle = isExcluded ? 'background-color: #f8f9fa; opacity: 0.7;' : '';
                                    const excludedIndicator = isExcluded ? ' 🚫' : '';
                                    
                                    return `
                                        <tr style="${rowStyle}">
                                            <td><strong>${member.display_name || 'Unknown'}${excludedIndicator}</strong>${isExcluded ? '<br><small style="color: #dc3545;">Excluded from championships</small>' : ''}</td>
                                            <td>${member.cust_id || 'N/A'}</td>
                                            <td>${member.car_number || 'N/A'}</td>
                                            <td>
                                                <div id="driverClasses_${member.cust_id}">
                                                    ${nickNameClass ? `<span style="background: ${isExcluded ? '#000000' : '#28a745'}; color: white; padding: 2px 6px; border-radius: 3px; font-size: 11px; margin: 1px;">[${nickNameClass}] (Automatic from iRacing API Roster Nickname)</span>` : '<span style="color: #666;">No classes assigned</span>'}
                                                </div>
                                            </td>
                                            <td>
                                                <div style="display: flex; gap: 5px; align-items: center; flex-wrap: wrap;">
                                                    <select id="classSelect_${member.cust_id}" style="padding: 3px; font-size: 12px; min-width: 80px;">
                                                        <option value="">-- Select Class --</option>
                                                        ${classOptions}
                                                        <option value="EXCLUDED" style="background-color: #000000; color: white;">🚫 EXCLUDED (No Championships)</option>
                                                    </select>
                                                    <button onclick="addClassToDriver('${member.cust_id}', '${member.display_name}')" 
                                                            style="background: #28a745; color: white; border: none; padding: 3px 8px; border-radius: 3px; cursor: pointer; font-size: 11px;">
                                                        Add Class
                                                    </button>
                                                    <button onclick="manageDriverClasses('${member.cust_id}', '${member.display_name}')" 
                                                            style="background: #17a2b8; color: white; border: none; padding: 3px 8px; border-radius: 3px; cursor: pointer; font-size: 11px;">
                                                        Manage
                                                    </button>
                                                </div>
                                            </td>
                                        </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        </table>
                    `;
                    
                    // Load and display current class assignments for each driver
                    roster.forEach(member => {
                        loadDriverClasses(member.cust_id);
                    });
                });
            } else {
                container.innerHTML = '<p>No roster data available.</p>';
            }
        }
    </script>
</body>
</html>